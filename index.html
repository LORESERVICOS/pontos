<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relógio de Ponto Eletrônico (Planilha)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.19/jspdf.plugin.autotable.min.js"></script>
<style>
body{font-family:Inter;background:#f8fafc;margin:0}
header{background:#1e40af;color:#fff;padding:20px;font-size:16px}
.card{background:#fff;padding:25px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.05);margin:20px auto}
button{padding:6px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff;cursor:pointer;margin:2px}
button:hover{background:#1d4ed8}
.hidden{display:none}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:13px}
th{background:#f1f5f9}
input,select{padding:4px 6px;margin:2px 0;}
.small-btn{font-size:11px;padding:4px 8px;}
.small-btn-danger{background:#dc2626;}
.small-btn-danger:hover{background:#b91c1c;}
</style>
</head>
<body>
<header>
  Bem-vindo, <span id="nomeUsuario"></span>
</header>

<!-- LOGIN -->
<div id="loginSection" class="card" style="max-width:400px">
  <h2>Login</h2>
  <input id="username" placeholder="Usuário"><br><br>
  <input id="password" type="password" placeholder="Senha"><br><br>
  <button onclick="login()">Entrar</button>
  <div id="msgLogin" style="margin-top:8px;font-size:13px;color:#b91c1c;"></div>
</div>

<!-- OPERACIONAL -->
<div id="operacionalSection" class="hidden">
  <div class="card" style="max-width:600px">
    <h2>Registro de Ponto</h2>
    <div id="dataAtual"></div>
    <div id="horaAtual"></div>
    <hr>
    <div id="botoesRegistro"></div>
    <hr>
    <h3>Marcações do Dia</h3>
    <div id="registrosUsuario"></div>
    <hr>
    <button onclick="logout()">Sair</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminSection" class="hidden">
  <div class="card" style="max-width:1200px">
    <h2>Admin – Funcionários e Relatórios</h2>
    <button onclick="abrirCadastroFuncionario()">Cadastro / Edição de Funcionário</button>
    <br><br>
    <h3>Relatório simples por período</h3>
    <select id="funcionarioSelect"></select>
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <button onclick="gerarRelatorio()">Gerar</button>
    <button onclick="gerarPDFRelatorio()">PDF</button>
    <button onclick="logout()">Sair</button>
    <div id="cartaoFuncionario" style="margin-top:15px;"></div>
  </div>
</div>

<!-- MODAL CADASTRO FUNCIONARIO -->
<div id="modalFuncionario" class="card hidden" style="max-width:500px">
  <h3>Cadastro / Edição de Funcionário</h3>

  <label>Usuário (login):<br>
    <input id="novoUser" placeholder="Usuário">
  </label><br>

  <label>Senha:<br>
    <input id="novoPass" type="password" placeholder="Senha">
  </label><br>

  <label>Nome Funcionário:<br>
    <input id="novoNome" placeholder="Nome completo">
  </label><br>

  <label>PIS:<br>
    <input id="novoPis" placeholder="PIS">
  </label><br>

  <label>Cargo:<br>
    <input id="novoCargo" placeholder="Cargo/Função">
  </label><br>

  <label>Depto/Setor:<br>
    <input id="novoSetor" placeholder="Departamento / Setor">
  </label><br>

  <label>Local de Trabalho:<br>
    <input id="novoLocal" placeholder="Local de trabalho">
  </label><br>

  <label>Perfil (role):<br>
    <select id="novoRole">
      <option value="operacional">Operacional</option>
      <option value="admin">Admin</option>
    </select>
  </label><br><br>

  <button onclick="salvarFuncionario()">Salvar</button>
  <button onclick="fecharCadastroFuncionario()">Cancelar</button>

  <hr>
  <h4>Funcionários cadastrados</h4>
  <div id="listaFuncionarios"></div>
</div>

<script>
// === CONFIG ===
// COLE AQUI A URL DO WEB APP (do Apps Script)
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxoR3SXsddBA5DT65iLKMCu-1dfIaghrHhGEDBhjCVpbHwAPNttstbjuMIpUuRrfLgdjA/exec";

let currentUser = null;
let currentRole = null;
let currentNome = "";

function login(){
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();
  const msg = document.getElementById("msgLogin");
  msg.textContent = "";

  if(!u || !p){
    msg.textContent = "Informe usuário e senha.";
    return;
  }

  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      tipo: "login",
      usuario: u,
      senha: p
    })
  })
  .then(r => r.json())
  .then(data => {
    if(data.status === "ok"){
      currentUser = data.usuario;
      currentRole = data.role;
      currentNome = data.nome || data.usuario;

      document.getElementById("nomeUsuario").textContent = currentNome;

      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("msgLogin").textContent = "";

      if(currentRole === "admin"){
        document.getElementById("adminSection").classList.remove("hidden");
        carregarFuncionarios();
      }else{
        document.getElementById("operacionalSection").classList.remove("hidden");
        iniciarRelogio();
        carregarRegistrosDia();
        montarBotoesRegistro();
      }
    }else{
      msg.textContent = data.message || "Login inválido.";
    }
  })
  .catch(err => {
    console.error(err);
    msg.textContent = "Erro ao conectar com o servidor.";
  });
}

function logout(){
  location.reload();
}

// === OPERACIONAL – RELÓGIO E REGISTROS DO DIA ===
function iniciarRelogio(){
  setInterval(()=>{
    const d = new Date();
    document.getElementById("dataAtual").textContent = "Data: " + d.toLocaleDateString("pt-BR");
    document.getElementById("horaAtual").textContent = "Hora: " + d.toLocaleTimeString("pt-BR");
  },1000);
}

function dataHojeBR(){
  const d = new Date();
  return d.toLocaleDateString("pt-BR"); // dd/mm/aaaa
}

function montarBotoesRegistro(){
  const div = document.getElementById("botoesRegistro");
  div.innerHTML = `
    <button onclick="registrar('entrada')">Entrada</button>
    <button onclick="registrar('saidaAlmoco')">Saída Almoço</button>
    <button onclick="registrar('retornoAlmoco')">Retorno</button>
    <button onclick="registrar('saida')">Saída</button>
  `;
}

function registrar(tipo){
  const hoje = dataHojeBR();

  if(!navigator.geolocation){
    enviarRegistro(tipo, hoje, "", "");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude.toFixed(5);
      const lng = pos.coords.longitude.toFixed(5);
      enviarRegistro(tipo, hoje, lat, lng);
    },
    err => {
      console.warn("Geo erro:", err);
      enviarRegistro(tipo, hoje, "", "");
    },
    {enableHighAccuracy:true, timeout:10000}
  );
}

function enviarRegistro(tipo, data, lat, lng){
  const agora = new Date();
  const hora = agora.toLocaleTimeString("pt-BR");

  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      tipo: "registroPonto",
      usuario: currentUser,
      tipoPonto: tipo, // só pra info, mas vamos usar 'tipo' também
      tipo: tipo,
      data: data,
      hora: hora,
      latitude: lat,
      longitude: lng
    })
  })
  .then(r => r.json())
  .then(data => {
    if(data.status === "ok"){
      carregarRegistrosDia();
    }else{
      alert(data.message || "Erro ao registrar ponto.");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Erro de comunicação com o servidor.");
  });
}

function carregarRegistrosDia(){
  const hoje = dataHojeBR();
  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      tipo: "registrosDia",
      usuario: currentUser,
      data: hoje
    })
  })
  .then(r => r.json())
  .then(data => {
    if(data.status === "ok"){
      const regs = data.registros || [];
      const div = document.getElementById("registrosUsuario");
      if(regs.length === 0){
        div.innerHTML = "<p>Nenhuma marcação hoje.</p>";
      }else{
        let html = "<table><tr><th>Data</th><th>Hora</th><th>Tipo</th><th>Latitude</th><th>Longitude</th></tr>";
        regs.forEach(r => {
          html += `<tr>
            <td>${r.data}</td>
            <td>${r.hora}</td>
            <td>${r.tipo}</td>
            <td>${r.latitude || ""}</td>
            <td>${r.longitude || ""}</td>
          </tr>`;
        });
        html += "</table>";
        div.innerHTML = html;
      }
    }else{
      console.error(data.message);
    }
  })
  .catch(err => console.error(err));
}

// === ADMIN – FUNCIONÁRIOS ===
function abrirCadastroFuncionario(){
  document.getElementById("modalFuncionario").classList.remove("hidden");
  carregarFuncionarios(); // atualiza lista na modal
}

function fecharCadastroFuncionario(){
  document.getElementById("modalFuncionario").classList.add("hidden");
}

function carregarFuncionarios(){
  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ tipo: "listaFuncionarios" })
  })
  .then(r => r.json())
  .then(data => {
    if(data.status === "ok"){
      const lista = data.funcionarios || [];
      // preenche select do relatório
      const sel = document.getElementById("funcionarioSelect");
      sel.innerHTML = "<option value=''>Selecionar Funcionário</option>";
      lista.forEach(f => {
        if(f.role === "operacional"){ // só colaborador no relatório
          const opt = document.createElement("option");
          opt.value = f.usuario_login;
          opt.textContent = f.nome || f.usuario_login;
          sel.appendChild(opt);
        }
      });

      // preenche lista da modal
      const divLista = document.getElementById("listaFuncionarios");
      if(lista.length === 0){
        divLista.innerHTML = "<p>Nenhum funcionário cadastrado.</p>";
      }else{
        let html = "<table><tr><th>Usuário</th><th>Nome</th><th>Role</th><th>Ações</th></tr>";
        lista.forEach(f => {
          html += `<tr>
            <td>${f.usuario_login}</td>
            <td>${f.nome}</td>
            <td>${f.role}</td>
            <td>
              <button class="small-btn" onclick="editarFuncionario('${f.usuario_login}','${f.role}')">Editar</button>
              <button class="small-btn small-btn-danger" onclick="excluirFuncionario('${f.usuario_login}')">Excluir</button>
            </td>
          </tr>`;
        });
        html += "</table>";
        divLista.innerHTML = html;
      }
    }else{
      alert(data.message || "Erro ao carregar funcionários.");
    }
  })
  .catch(err => console.error(err));
}

function salvarFuncionario(){
  const u = document.getElementById("novoUser").value.trim();
  const s = document.getElementById("novoPass").value.trim();
  const n = document.getElementById("novoNome").value.trim();
  const p = document.getElementById("novoPis").value.trim();
  const c = document.getElementById("novoCargo").value.trim();
  const st= document.getElementById("novoSetor").value.trim();
  const l = document.getElementById("novoLocal").value.trim();
  const r = document.getElementById("novoRole").value;

  if(!u || !s || !n){
    alert("Preencha pelo menos Usuário, Senha e Nome.");
    return;
  }

  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      tipo: "salvarFuncionario",
      funcionario:{
        usuario_login: u,
        senha: s,
        nome: n,
        pis: p,
        cargo: c,
        setor: st,
        local_trabalho: l,
        role: r
      }
    })
  })
  .then(r => r.json())
  .then(data => {
    if(data.status === "ok"){
      alert("Funcionário salvo com sucesso!");
      document.getElementById("novoUser").value = "";
      document.getElementById("novoPass").value = "";
      document.getElementById("novoNome").value = "";
      document.getElementById("novoPis").value = "";
      document.getElementById("novoCargo").value = "";
      document.getElementById("novoSetor").value = "";
      document.getElementById("novoLocal").value = "";
      document.getElementById("novoRole").value = "operacional";
      carregarFuncionarios();
    }else{
      alert(data.message || "Erro ao salvar funcionário.");
    }
  })
  .catch(err => console.error(err));
}

function editarFuncionario(usuario, role){
  // Preenche o campo de login e role; admin pode sobrescrever
  document.getElementById("novoUser").value = usuario;
  document.getElementById("novoRole").value = role || "operacional";
  alert("Edite os campos desejados e clique em SALVAR para atualizar.");
}

function excluirFuncionario(usuario){
  if(usuario.toLowerCase() === "admin"){
    alert("Não é permitido excluir o admin.");
    return;
  }

  if(!confirm("Deseja realmente excluir o funcionário e seus registros?")) return;

  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      tipo: "excluirFuncionario",
      usuario_login: usuario
    })
  })
  .then(r => r.json())
  .then(data => {
    if(data.status === "ok"){
      alert("Funcionário excluído com sucesso!");
      carregarFuncionarios();
    }else{
      alert(data.message || "Erro ao excluir funcionário.");
    }
  })
  .catch(err => console.error(err));
}

// === ADMIN – RELATÓRIO SIMPLES POR PERÍODO ===
function gerarRelatorio(){
  const u = document.getElementById("funcionarioSelect").value;
  const di = document.getElementById("dataInicio").value;
  const df = document.getElementById("dataFim").value;
  const div = document.getElementById("cartaoFuncionario");
  div.innerHTML = "";

  if(!u || !di || !df){
    alert("Selecione funcionário, data início e data fim.");
    return;
  }

  // converter yyyy-mm-dd para dd/mm/aaaa
  function toBR(d){
    const [a,m,dd] = d.split("-");
    return `${dd}/${m}/${a}`;
  }

  const diBR = toBR(di);
  const dfBR = toBR(df);

  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      tipo: "registrosPeriodo",
      usuario: u,
      dataInicio: diBR,
      dataFim: dfBR
    })
  })
  .then(r => r.json())
  .then(data => {
    if(data.status === "ok"){
      const regs = data.registros || [];
      if(regs.length === 0){
        div.innerHTML = "<p>Sem registros no período.</p>";
      }else{
        let html = `<h3>Registros – ${u}</h3>`;
        html += `<p>Período: ${diBR} a ${dfBR}</p>`;
        html += `<table id="tabelaRelatorio"><tr>
          <th>Data</th><th>Hora</th><th>Tipo</th><th>Latitude</th><th>Longitude</th>
        </tr>`;
        regs.forEach(r => {
          html += `<tr>
            <td>${r.data}</td>
            <td>${r.hora}</td>
            <td>${r.tipo}</td>
            <td>${r.latitude || ""}</td>
            <td>${r.longitude || ""}</td>
          </tr>`;
        });
        html += "</table>";
        div.innerHTML = html;
      }
    }else{
      alert(data.message || "Erro ao buscar registros.");
    }
  })
  .catch(err => console.error(err));
}

// PDF simples do relatório
function gerarPDFRelatorio(){
  const tabela = document.getElementById("tabelaRelatorio");
  if(!tabela){
    alert("Gere o relatório antes de exportar para PDF.");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","mm","a4");
  doc.setFontSize(12);
  doc.text("Relatório de Ponto", 105, 10, {align:"center"});
  doc.autoTable({ startY: 20, html: tabela });
  doc.save("relatorio_ponto.pdf");
}
</script>
</body>
</html>
