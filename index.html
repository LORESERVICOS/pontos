<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Rel√≥gio de Ponto Eletr√¥nico</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.19/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>

<style>
  body{font-family:Inter;background:#f8fafc;margin:0}
  header{background:#1e40af;color:#fff;padding:20px;font-size:16px}
  .card{background:#fff;padding:25px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.05);margin:20px auto}
  button{padding:6px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff;cursor:pointer;margin:2px}
  button:hover{background:#1d4ed8}
  button:disabled{opacity:.6;cursor:not-allowed}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:13px}
  th{background:#f1f5f9}
  .verde{color:green;font-weight:bold;}
  .vermelho{color:red;font-weight:bold;}
  input,select{padding:6px 8px;margin:2px 0;border:1px solid #d1d5db;border-radius:10px;outline:none}
  input:focus,select:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:#64748b;font-size:12px}
  .danger{background:#dc2626}
  .danger:hover{background:#b91c1c}
  .ghost{background:#0f172a}
  .ghost:hover{background:#111827}
  .pill{display:inline-block;background:#eef2ff;color:#3730a3;padding:4px 8px;border-radius:999px;font-size:12px}
</style>
</head>

<body>
<header>
  Bem-vindo, <span id="nomeUsuario"></span>
</header>

<!-- LOGIN -->
<div id="loginSection" class="card" style="max-width:420px">
  <h2 style="margin-top:0">Login</h2>
  <div class="muted">Login √© validado <strong>pela planilha (Apps Script)</strong>. N√£o usa login local.</div>
  <br>
  <input id="username" placeholder="Usu√°rio" autocomplete="off" style="width:100%"><br><br>
  <input id="password" type="password" placeholder="Senha" autocomplete="off" style="width:100%"><br><br>
  <button id="btnLogin" onclick="login()">Entrar</button>
  <div id="loginMsg" style="margin-top:10px;font-size:13px;color:#b91c1c;"></div>
</div>

<!-- OPERACIONAL -->
<div id="operacionalSection" class="hidden">
  <div class="card" style="max-width:680px">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Registro de Ponto</h2>
      <span id="badgeRole" class="pill"></span>
    </div>
    <div id="dataAtual" style="margin-top:10px"></div>
    <div id="horaAtual"></div>
    <hr>
    <div id="botoesRegistro"></div>
    <hr>
    <h3>Marca√ß√µes do Dia</h3>
    <div id="registrosUsuario"></div>
    <hr>
    <button onclick="logout()">Sair</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminSection" class="hidden">
  <div class="card" style="max-width:1250px">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Relat√≥rio ‚Äì Cart√£o de Ponto</h2>
      <span id="badgeRoleAdmin" class="pill"></span>
    </div>

    <div class="row" style="margin-top:10px">
      <button onclick="abrirCadastroFuncionario()">Cadastro / Edi√ß√£o de Funcion√°rio</button>
      <button onclick="abrirEscalaMensal()">Editar Escala Mensal</button>
      <button class="ghost" onclick="recarregarFuncionarios()">Recarregar funcion√°rios</button>
      <button onclick="logout()">Sair</button>
    </div>

    <br>
    <div class="row">
      <select id="funcionarioSelect" onchange="gerarRelatorioMensal()"></select>
      <input type="date" id="dataInicio">
      <input type="date" id="dataFim">
      <select id="tipoRelatorio">
        <option value="simples">Relat√≥rio Simples</option>
        <option value="comGeo">Com Geolocaliza√ß√£o</option>
      </select>
      <button onclick="gerarRelatorioMensal()">Gerar</button>
      <button onclick="gerarExcel()">Excel</button>
      <button onclick="gerarPDFAdmin()">PDF</button>
    </div>

    <div id="cartaoFuncionario"></div>
  </div>
</div>

<!-- MODAL CADASTRO FUNCIONARIO -->
<div id="modalFuncionario" class="card hidden" style="max-width:560px">
  <div class="row" style="justify-content:space-between">
    <h3 style="margin:0">Cadastro / Edi√ß√£o de Funcion√°rio</h3>
    <span id="modoFuncionario" class="pill">NOVO</span>
  </div>
  <div class="muted" style="margin-top:8px">
    Tudo aqui √© salvo na <strong>planilha</strong> (din√¢mico). Depois de salvar, o login j√° funciona.
  </div>
  <hr>

  <label>C√≥digo Funcion√°rio:<br>
    <input id="novoCodigo" placeholder="C√≥digo" style="width:100%">
  </label><br>

  <label>Nome Funcion√°rio:<br>
    <input id="novoNome" placeholder="Nome completo" style="width:100%">
  </label><br>

  <label>Usu√°rio (login):<br>
    <input id="novoUser" placeholder="Usu√°rio" style="width:100%">
  </label><br>

  <label>Senha:<br>
    <input id="novoPass" type="password" placeholder="Senha" style="width:100%">
  </label><br>

  <label>Cargo:<br>
    <input id="novoCargo" placeholder="Cargo/Fun√ß√£o" style="width:100%">
  </label><br>

  <label>PIS:<br>
    <input id="novoPis" placeholder="PIS" style="width:100%">
  </label><br>

  <label>Depto/Setor:<br>
    <input id="novoSetor" placeholder="Departamento / Setor" style="width:100%">
  </label><br>

  <label>Local de Trabalho:<br>
    <input id="novoLocal" placeholder="Local de trabalho" style="width:100%">
  </label><br>

  <label>Role (perfil):<br>
    <select id="novoRole" style="width:100%">
      <option value="operacional">operacional</option>
      <option value="admin">admin</option>
    </select>
  </label><br>

  <p><strong>Escala padr√£o semanal do funcion√°rio</strong><br>
    Digite <strong>HH:MM</strong> para a carga di√°ria ou <strong>FOLGA</strong>.
  </p>

  <div class="row">
    <div style="flex:1;min-width:170px">
      <label>Segunda-feira:<br><input id="escSeg" placeholder="HH:MM ou FOLGA" value="08:00" style="width:100%"></label>
    </div>
    <div style="flex:1;min-width:170px">
      <label>Ter√ßa-feira:<br><input id="escTer" placeholder="HH:MM ou FOLGA" value="08:00" style="width:100%"></label>
    </div>
    <div style="flex:1;min-width:170px">
      <label>Quarta-feira:<br><input id="escQua" placeholder="HH:MM ou FOLGA" value="08:00" style="width:100%"></label>
    </div>
  </div>

  <div class="row">
    <div style="flex:1;min-width:170px">
      <label>Quinta-feira:<br><input id="escQui" placeholder="HH:MM ou FOLGA" value="08:00" style="width:100%"></label>
    </div>
    <div style="flex:1;min-width:170px">
      <label>Sexta-feira:<br><input id="escSex" placeholder="HH:MM ou FOLGA" value="08:00" style="width:100%"></label>
    </div>
    <div style="flex:1;min-width:170px">
      <label>S√°bado:<br><input id="escSab" placeholder="HH:MM ou FOLGA" value="04:00" style="width:100%"></label>
    </div>
  </div>

  <label>Domingo:<br>
    <input id="escDom" placeholder="HH:MM ou FOLGA" value="FOLGA" style="width:100%">
  </label><br><br>

  <div class="row">
    <button id="btnSalvarFunc" onclick="salvarFuncionario()">Salvar</button>
    <button onclick="fecharCadastroFuncionario()">Cancelar</button>
    <button id="btnExcluirFunc" class="danger hidden" onclick="excluirFuncionario()">Excluir</button>
  </div>

  <div id="msgFuncionario" class="muted" style="margin-top:10px"></div>
</div>

<!-- MODAL ESCALA MENSAL -->
<div id="modalEscala" class="card hidden" style="max-width:680px;max-height:520px;overflow:auto">
  <h3>Editar Escala Mensal (manual)</h3>
  <p class="muted">Formato HH:MM por dia (opcional ‚Äì usado se quiser sobrescrever a escala semanal). (Fica no navegador, como voc√™ j√° usava.)</p>
  <div id="conteudoEscala"></div>
  <button onclick="salvarEscalaMensal()">Salvar Escala</button>
  <button onclick="fecharEscalaMensal()">Cancelar</button>
</div>

<script>
/** =========================================================
 *  ‚úÖ CONFIGURE AQUI A URL DO SEU WEB APP (Apps Script) /exec
 *  ========================================================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwxBa-DDtruDJFQhBEPonsRnrv0jb2gB7etz9EsoEj9MGuXmDs0hJpab0Tv7zXoMgq/exec";

/** =========================================================
 *  ‚úÖ Estado em mem√≥ria (sem login local)
 *  ========================================================= */
let users = {};             // guarda dados do logado + cache de funcion√°rios
let currentUser = null;     // login atual
let currentRole = null;     // role atual
let dadosAtual = {}, dataAtualRel = "";

const feriados = ["01/01","07/09","25/12"];

const justificativas = [
  "Nenhum",
  "F√©rias",
  "Falta Justificada",
  "Falta Injustificada",
  "Falta Abonada",
  "Atestado M√©dico Dias",
  "Atestado M√©dico Horas",
  "Licen√ßa Maternidade",
  "Licen√ßa Paternidade",
  "Licen√ßa INSS+15 D",
  "Acidente de Trabalho",
  "Feriado"
];

/** =========================================================
 *  Utils
 *  ========================================================= */
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

function hm(h){
  if(!h || typeof h!=="string" || !h.includes(":")) return 0;
  const [x,y] = h.split(":").map(Number);
  return x*60 + y;
}
function fmt(m){
  const sign = m<0 ? "-" : "";
  const abs = Math.abs(m);
  const h = String(Math.floor(abs/60)).padStart(2,"0");
  const mm = String(abs%60).padStart(2,"0");
  return sign + h + ":" + mm;
}
function cargaEscalaMin(escStr){
  if(!escStr) return 0;
  const s = escStr.toString().toUpperCase().trim();
  if(s==="FOLGA") return 0;
  if(/^\d{2}:\d{2}$/.test(s)) return hm(s);
  if(s.includes("=")){
    const partes = s.split("=");
    const carga = partes[partes.length-1].trim();
    if(/^\d{2}:\d{2}$/.test(carga)) return hm(carga);
  }
  return 0;
}

async function apiPost_(payload){
  const resp = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"text/plain;charset=utf-8"}, // evita CORS preflight
    body: JSON.stringify(payload)
  });
  const text = await resp.text();
  try { return JSON.parse(text); }
  catch(e){ throw new Error("WebApp n√£o retornou JSON: " + text.slice(0,200)); }
}

function setTela_(tela){
  loginSection.classList.add("hidden");
  operacionalSection.classList.add("hidden");
  adminSection.classList.add("hidden");

  if(tela==="login") loginSection.classList.remove("hidden");
  if(tela==="operacional") operacionalSection.classList.remove("hidden");
  if(tela==="admin") adminSection.classList.remove("hidden");
}

function setBadge_(){
  const txt = currentRole ? `perfil: ${currentRole}` : "";
  if(document.getElementById("badgeRole")) badgeRole.textContent = txt;
  if(document.getElementById("badgeRoleAdmin")) badgeRoleAdmin.textContent = txt;
}

/** =========================================================
 *  ‚úÖ Sess√£o (somente na aba)
 *  ========================================================= */
async function restaurarSessaoSePossivel(){
  const ok = sessionStorage.getItem("auth_ok") === "1";
  const u = sessionStorage.getItem("auth_user");
  const p = sessionStorage.getItem("auth_pass");

  if(!ok || !u || !p){
    setTela_("login");
    return;
  }

  try{
    const data = await apiPost_({ tipo:"login", usuario:u, senha:p });
    if(data.status !== "ok"){
      sessionStorage.clear();
      setTela_("login");
      return;
    }
    aplicarUsuarioLogado_(u,p,data.user || {});
  }catch(e){
    console.error(e);
    setTela_("login");
  }
}

/** =========================================================
 *  ‚úÖ LOGIN (sempre pela planilha)
 *  ========================================================= */
async function login(){
  const u = username.value.trim();
  const p = password.value.trim();
  loginMsg.textContent = "";

  if(!u || !p){
    loginMsg.textContent = "Preencha usu√°rio e senha.";
    return;
  }

  btnLogin.disabled = true;
  btnLogin.textContent = "Validando...";

  try{
    const data = await apiPost_({ tipo:"login", usuario:u, senha:p });

    if(data.status !== "ok"){
      loginMsg.textContent = data.message || "Login inv√°lido";
      password.value = "";
      return;
    }

    aplicarUsuarioLogado_(u, p, data.user || {});
    username.value = "";
    password.value = "";

  }catch(e){
    console.error(e);
    loginMsg.textContent = "Erro ao conectar com o WebApp. Veja F12 > Console.";
  }finally{
    btnLogin.disabled = false;
    btnLogin.textContent = "Entrar";
  }
}

function aplicarUsuarioLogado_(u, p, info){
  currentUser = u;
  currentRole = (info.role || "operacional").toLowerCase();

  // cache do usu√°rio logado
  users[currentUser] = {
    password: p, // compatibilidade (n√£o √© usado pra validar localmente)
    role: currentRole,
    pis: info.pis || "",
    codigo: info.codigo || "",
    nomeCompleto: info.nomeCompleto || info.nome || u,
    cargo: info.cargo || "",
    setor: info.setor || "",
    localTrabalho: info.localTrabalho || info.local_trabalho || "",
    escalaMensal: users[currentUser]?.escalaMensal || {},
    escalaSemanal: info.escalaSemanal || {1:"08:00",2:"08:00",3:"08:00",4:"08:00",5:"08:00",6:"04:00",0:"FOLGA"}
  };

  nomeUsuario.textContent = users[currentUser].nomeCompleto || currentUser;
  setBadge_();

  sessionStorage.setItem("auth_ok","1");
  sessionStorage.setItem("auth_user",u);
  sessionStorage.setItem("auth_pass",p);

  if(currentRole === "admin"){
    setTela_("admin");
    recarregarFuncionarios();
  }else{
    setTela_("operacional");
    mostrarDataHora();
    mostrarRegistrosUsuario();
  }
}

function logout(){
  sessionStorage.clear();
  location.reload();
}

document.addEventListener("keydown", (ev)=>{
  if(!loginSection.classList.contains("hidden") && ev.key === "Enter"){
    ev.preventDefault();
    login();
  }
});

/** =========================================================
 *  ‚úÖ ADMIN: carregar lista din√¢mica da planilha
 *  ========================================================= */
async function recarregarFuncionarios(){
  const select = document.getElementById("funcionarioSelect");
  select.innerHTML = "<option value=''>Carregando...</option>";

  try{
    const data = await apiPost_({ tipo:"listarFuncionarios" });

    if(data.status !== "ok"){
      select.innerHTML = "<option value=''>Erro ao carregar</option>";
      alert("Erro ao carregar funcion√°rios: " + (data.message || ""));
      return;
    }

    const list = data.funcionarios || [];
    select.innerHTML = "<option value=''>Selecionar Funcion√°rio</option>";

    // cache b√°sico
    list.forEach(f=>{
      const login = (f.login || f.usuario_login || "").toString().trim();
      if(!login) return;
      users[login] = users[login] || {};
      users[login].role = (f.role || "operacional").toLowerCase();
      users[login].nomeCompleto = (f.nome || f.nomeCompleto || login);
    });

    list
      .filter(f => ((f.role || "operacional").toLowerCase() === "operacional"))
      .forEach(f=>{
        const login = (f.login || f.usuario_login || "").toString().trim();
        if(!login) return;
        const opt = document.createElement("option");
        opt.value = login;
        opt.textContent = f.nome || f.nomeCompleto || login;
        select.appendChild(opt);
      });

  }catch(e){
    console.error(e);
    select.innerHTML = "<option value=''>Erro ao carregar</option>";
    alert("Falha ao carregar funcion√°rios. Veja Console (F12).");
  }
}

/** =========================================================
 *  ‚úÖ ADMIN: abrir/editar cadastro direto da planilha
 *  ========================================================= */
function limparFormularioFuncionario_(){
  novoCodigo.value = "";
  novoNome.value   = "";
  novoUser.value   = "";
  novoPass.value   = "";
  novoCargo.value  = "";
  novoPis.value    = "";
  novoSetor.value  = "";
  novoLocal.value  = "";
  novoRole.value   = "operacional";
  escSeg.value = "08:00";
  escTer.value = "08:00";
  escQua.value = "08:00";
  escQui.value = "08:00";
  escSex.value = "08:00";
  escSab.value = "04:00";
  escDom.value = "FOLGA";
}

async function abrirCadastroFuncionario(){
  msgFuncionario.textContent = "";
  btnExcluirFunc.classList.add("hidden");

  const uSel = funcionarioSelect.value;

  modalFuncionario.classList.remove("hidden");

  // NOVO
  if(!uSel){
    modoFuncionario.textContent = "NOVO";
    limparFormularioFuncionario_();
    return;
  }

  // EDI√á√ÉO
  modoFuncionario.textContent = "EDITANDO";
  btnExcluirFunc.classList.remove("hidden");
  btnSalvarFunc.disabled = true;
  btnSalvarFunc.textContent = "Carregando...";

  try{
    const data = await apiPost_({ tipo:"obterFuncionario", usuario: uSel });

    if(data.status !== "ok"){
      alert("N√£o consegui carregar o funcion√°rio: " + (data.message || ""));
      limparFormularioFuncionario_();
      return;
    }

    const f = data.funcionario || {};
    novoCodigo.value = (f.codigo || "");
    novoNome.value   = (f.nome || f.nomeCompleto || uSel);
    novoUser.value   = (f.usuario_login || uSel);
    novoPass.value   = (f.senha_ponto || "");
    novoCargo.value  = (f.cargo || "");
    novoPis.value    = (f.pis || "");
    novoSetor.value  = (f.setor || "");
    novoLocal.value  = (f.local_trabalho || f.localTrabalho || "");
    novoRole.value   = ((f.role || "operacional").toLowerCase());

    escSeg.value = (f.escSeg || "08:00");
    escTer.value = (f.escTer || "08:00");
    escQua.value = (f.escQua || "08:00");
    escQui.value = (f.escQui || "08:00");
    escSex.value = (f.escSex || "08:00");
    escSab.value = (f.escSab || "04:00");
    escDom.value = (f.escDom || "FOLGA");

  }catch(e){
    console.error(e);
    alert("Erro ao carregar funcion√°rio. Veja Console (F12).");
  }finally{
    btnSalvarFunc.disabled = false;
    btnSalvarFunc.textContent = "Salvar";
  }
}

function fecharCadastroFuncionario(){
  modalFuncionario.classList.add("hidden");
}

async function salvarFuncionario(){
  msgFuncionario.textContent = "";

  const codigo = novoCodigo.value.trim();
  const nome   = novoNome.value.trim();
  const u      = novoUser.value.trim();
  const p      = novoPass.value.trim();
  const cargo  = novoCargo.value.trim();
  const pis    = novoPis.value.trim();
  const setor  = novoSetor.value.trim();
  const local  = novoLocal.value.trim();
  const role   = (novoRole.value || "operacional").toLowerCase();

  const eSeg = (escSeg.value || "").trim() || "08:00";
  const eTer = (escTer.value || "").trim() || eSeg;
  const eQua = (escQua.value || "").trim() || eSeg;
  const eQui = (escQui.value || "").trim() || eSeg;
  const eSex = (escSex.value || "").trim() || eSeg;
  const eSab = (escSab.value || "").trim() || "04:00";
  const eDom = (escDom.value || "").trim() || "FOLGA";

  if(!u || !p || !nome){
    msgFuncionario.textContent = "Preencha pelo menos: Nome, Usu√°rio e Senha.";
    return;
  }

  btnSalvarFunc.disabled = true;
  btnSalvarFunc.textContent = "Salvando...";

  try{
    const data = await apiPost_({
      tipo: "salvarFuncionario",
      usuario: u,
      senha: p,
      codigo: codigo,
      nome: nome,
      pis: pis,
      cargo: cargo,
      setor: setor,
      localTrabalho: local,
      escSeg: eSeg,
      escTer: eTer,
      escQua: eQua,
      escQui: eQui,
      escSex: eSex,
      escSab: eSab,
      escDom: eDom,
      role: role
    });

    if(data.status !== "ok"){
      msgFuncionario.textContent = "Erro ao salvar na planilha: " + (data.message || "");
      return;
    }

    // atualiza cache em mem√≥ria
    users[u] = users[u] || {};
    users[u].nomeCompleto = nome || u;
    users[u].role = role;
    users[u].pis = pis;
    users[u].codigo = codigo;
    users[u].cargo = cargo;
    users[u].setor = setor;
    users[u].localTrabalho = local;
    users[u].escalaSemanal = {1:eSeg,2:eTer,3:eQua,4:eQui,5:eSex,6:eSab,0:eDom};

    msgFuncionario.textContent = "‚úÖ Salvo na planilha.";
    await recarregarFuncionarios();

    if(currentUser && u.toLowerCase() === currentUser.toLowerCase()){
      nomeUsuario.textContent = nome || currentUser;
    }

    setTimeout(()=>fecharCadastroFuncionario(), 350);

  }catch(e){
    console.error(e);
    msgFuncionario.textContent = "Erro ao conectar no WebApp. Veja Console (F12).";
  }finally{
    btnSalvarFunc.disabled = false;
    btnSalvarFunc.textContent = "Salvar";
  }
}

async function excluirFuncionario(){
  const u = novoUser.value.trim();
  if(!u) return;

  if(u.toLowerCase() === "admin"){
    alert("N√£o √© permitido excluir o admin.");
    return;
  }

  if(!confirm("Tem certeza que deseja EXCLUIR o usu√°rio '" + u + "'?")) return;

  btnExcluirFunc.disabled = true;
  btnExcluirFunc.textContent = "Excluindo...";

  try{
    const data = await apiPost_({ tipo:"excluirFuncionario", usuario:u });
    if(data.status !== "ok"){
      alert("Erro ao excluir: " + (data.message || ""));
      return;
    }
    alert("‚úÖ Usu√°rio exclu√≠do.");
    fecharCadastroFuncionario();
    await recarregarFuncionarios();
  }catch(e){
    console.error(e);
    alert("Erro ao conectar para excluir. Veja Console (F12).");
  }finally{
    btnExcluirFunc.disabled = false;
    btnExcluirFunc.textContent = "Excluir";
  }
}

/** =========================================================
 *  OPERACIONAL: registros (localStorage)
 *  ========================================================= */
function registrar(tipo){
  const agora = new Date();
  const hora = agora.toLocaleTimeString().slice(0,5);
  const data = agora.toLocaleDateString();
  navigator.geolocation.getCurrentPosition(
    pos => salvarRegistro(tipo, hora, data, `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`),
    ()  => salvarRegistro(tipo, hora, data, "N√£o registrada")
  );
}

function salvarRegistro(tipo, hora, data, geo){
  const d = JSON.parse(localStorage.getItem("registros") || "{}");
  d[currentUser] ??= {};
  d[currentUser][data] ??= {};
  d[currentUser][data][tipo] = hora;
  d[currentUser][data]["geo"+capitalize(tipo)] = geo;
  localStorage.setItem("registros", JSON.stringify(d));
  mostrarRegistrosUsuario();
}

function mostrarDataHora(){
  setInterval(()=>{
    const a = new Date();
    dataAtual.textContent = "Data: " + a.toLocaleDateString();
    horaAtual.textContent = "Hora: " + a.toLocaleTimeString();
  }, 1000);
}

function mostrarRegistrosUsuario(){
  const hoje = new Date().toLocaleDateString();
  const d = JSON.parse(localStorage.getItem("registros") || "{}");
  const r = d[currentUser]?.[hoje] || {};

  registrosUsuario.innerHTML = "";
  botoesRegistro.innerHTML = "";

  ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(t=>{
    if(r[t]){
      registrosUsuario.innerHTML += `<div><strong>${capitalize(t)}:</strong> ${r[t]}
        <button style="font-size:11px" onclick="gerarComprovante('${t}')">üìÑ PDF</button>
      </div>`;
    }
  });

  if(!r.entrada) botoesRegistro.innerHTML = `<button onclick="registrar('entrada')">Entrada</button>`;
  else if(!r.saidaAlmoco) botoesRegistro.innerHTML = `<button onclick="registrar('saidaAlmoco')">Sa√≠da Almo√ßo</button>`;
  else if(!r.retornoAlmoco) botoesRegistro.innerHTML = `<button onclick="registrar('retornoAlmoco')">Retorno</button>`;
  else if(!r.saida) botoesRegistro.innerHTML = `<button onclick="registrar('saida')">Sa√≠da</button>`;
  else botoesRegistro.innerHTML = "‚úÖ Jornada finalizada";
}

/** ====== COMPROVANTE INDIVIDUAL ====== */
function gerarComprovante(tipo){
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF();
  const hoje = new Date().toLocaleDateString();
  const d = JSON.parse(localStorage.getItem("registros") || "{}");
  const r = d[currentUser]?.[hoje] || {};
  const hora = r[tipo] || "";
  const geo = r["geo"+capitalize(tipo)] || "";

  doc.setFontSize(14);
  doc.text("COMPROVANTE DE REGISTRO DE PONTO",105,15,{align:"center"});
  doc.setFontSize(11);
  doc.text(`Colaborador: ${users[currentUser]?.nomeCompleto || currentUser}`,14,30);
  doc.text(`PIS: ${users[currentUser]?.pis || ""}`,14,36);
  doc.text(`Data: ${hoje}`,14,42);
  doc.text(`Tipo de Marca√ß√£o: ${capitalize(tipo)}`,14,48);
  doc.text(`Hor√°rio: ${hora}`,14,54);
  doc.text(`Geolocaliza√ß√£o: ${geo}`,14,60);
  doc.save(`comprovante_${tipo}_${hoje}.pdf`);
}

/** =========================================================
 *  AJUSTE (igual ao seu)
 *  ========================================================= */
function campo(valor, c, adminView = true){
  const vazio = !valor || valor === "-";
  const evento = dadosAtual[c+"_evento"];

  if(!vazio && !evento){
    if(adminView){
      return valor + (dadosAtual[c+"_editado"]
        ? ` <button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${dataAtualRel}','${c}')">Editar</button>`
        : "");
    }
    return valor;
  }

  if(evento){
    if(adminView){
      return evento +
        ` <button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${dataAtualRel}','${c}')">Editar</button>`;
    }
    return evento;
  }

  if(adminView){
    return `<button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${dataAtualRel}','${c}')">‚ûï Ajustar</button>`;
  }
  return "";
}

function abrirAjuste(u,d,c){
  const dados = JSON.parse(localStorage.getItem("registros")||"{}");
  dados[u]??={};
  dados[u][d]??={};
  const atual = dados[u][d];

  let popup = document.createElement("div");
  popup.style.position="fixed";
  popup.style.top="50%";
  popup.style.left="50%";
  popup.style.transform="translate(-50%,-50%)";
  popup.style.background="#fff";
  popup.style.padding="20px";
  popup.style.border="1px solid #333";
  popup.style.zIndex=1000;
  popup.style.borderRadius="12px";
  popup.style.boxShadow="0 10px 30px rgba(0,0,0,.2)";

  popup.innerHTML=`
    <h3 style="margin-top:0">Ajustar ${c}</h3>
    <label>Horas: <input type="text" id="inputHoras" placeholder="HH:MM" value="${atual[c]||""}"></label><br><br>
    <label>Justificar:
      <select id="selectJustificacao">
        <option value="">--Escolha--</option>
        ${justificativas.map(j=>`<option value="${j}" ${atual[c+"_evento"]===j?'selected':''}>${j}</option>`).join("")}
      </select>
    </label><br><br>
    <button id="okBtn">Ok</button>
    <button id="cancelBtn" class="danger">Cancelar</button>
  `;

  document.body.appendChild(popup);

  popup.querySelector("#okBtn").onclick=()=>{
    const h = popup.querySelector("#inputHoras").value.trim();
    const ev = popup.querySelector("#selectJustificacao").value;

    if(ev === "Nenhum"){
      ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
        delete atual[campoNome+"_evento"];
        delete atual[campoNome+"_editado"];
        if(atual[campoNome] === "-" || atual[campoNome] === "" || atual[campoNome] == null){
          delete atual[campoNome];
        }
      });
      delete atual.atestadoHorasMin;
      localStorage.setItem("registros",JSON.stringify(dados));
      popup.remove();
      gerarRelatorioMensal();
      return;
    }

    if(ev === "Atestado M√©dico Dias"){
      const intervalo = prompt("Informe o intervalo do atestado (formato: dd/mm/aaaa - dd/mm/aaaa):", d+" - "+d);
      if(intervalo){
        const partes = intervalo.split("-");
        if(partes.length===2){
          const iniStr = partes[0].trim();
          const fimStr = partes[1].trim();
          const [di,mi,ai] = iniStr.split("/").map(Number);
          const [df,mf,af] = fimStr.split("/").map(Number);
          if(di&&mi&&ai&&df&&mf&&af){
            let dataIni = new Date(ai,mi-1,di);
            let dataFim = new Date(af,mf-1,df);
            if(dataIni > dataFim){
              const tmp = dataIni; dataIni = dataFim; dataFim = tmp;
            }
            let cursor = new Date(dataIni);
            while(cursor <= dataFim){
              const cdia = String(cursor.getDate()).padStart(2,"0");
              const cmes = String(cursor.getMonth()+1).padStart(2,"0");
              const cano = cursor.getFullYear();
              const chave = `${cdia}/${cmes}/${cano}`;
              dados[u]??={};
              dados[u][chave]??={};
              const reg = dados[u][chave];
              ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
                reg[campoNome]="-";
                reg[campoNome+"_evento"]=ev;
                reg[campoNome+"_editado"]=true;
              });
              delete reg.atestadoHorasMin;
              cursor.setDate(cursor.getDate()+1);
            }
            localStorage.setItem("registros",JSON.stringify(dados));
            popup.remove();
            gerarRelatorioMensal();
            return;
          }
        }
      }
    }

    if(ev === "Atestado M√©dico Horas"){
      const dataAtestadoStr = prompt("Data do atestado (dd/mm/aaaa):", d);
      if(!dataAtestadoStr){ popup.remove(); return; }
      const [ddia,dmes,dano] = dataAtestadoStr.split("/").map(Number);
      if(!ddia||!dmes||!dano){ popup.remove(); return; }
      const dataAtestadoKey = `${String(ddia).padStart(2,"0")}/${String(dmes).padStart(2,"0")}/${dano}`;
      const hIni = prompt("Hora IN√çCIO do atestado (HH:MM):","08:00");
      const hFim = prompt("Hora FIM do atestado (HH:MM):","10:00");
      if(!hIni || !hFim){ popup.remove(); return; }
      const minutosAtestado = Math.max(0, hm(hFim) - hm(hIni));
      dados[u]??={};
      dados[u][dataAtestadoKey]??={};
      const regA = dados[u][dataAtestadoKey];
      ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
        regA[campoNome]="-";
        regA[campoNome+"_evento"]=ev;
        regA[campoNome+"_editado"]=true;
      });
      regA.atestadoHorasMin = minutosAtestado;
      localStorage.setItem("registros",JSON.stringify(dados));
      popup.remove();
      gerarRelatorioMensal();
      return;
    }

    if(h){
      atual[c]=h;
      atual[c+"_evento"]="";
      atual[c+"_editado"]=true;
      delete atual.atestadoHorasMin;
    } else if(ev){
      ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
        atual[campoNome]="-";
        atual[campoNome+"_evento"]=ev;
        atual[campoNome+"_editado"]=true;
      });
      delete atual.atestadoHorasMin;
    }

    localStorage.setItem("registros",JSON.stringify(dados));
    popup.remove();
    gerarRelatorioMensal();
  };

  popup.querySelector("#cancelBtn").onclick=()=>{popup.remove();};
}

/** =========================================================
 *  RELAT√ìRIO (registros locais + escala da planilha via obterFuncionario)
 *  ========================================================= */
async function garantirFuncionarioCarregado_(u){
  if(users[u]?.escalaSemanal) return;

  try{
    const data = await apiPost_({ tipo:"obterFuncionario", usuario:u });
    if(data.status !== "ok") return;

    const f = data.funcionario || {};
    users[u] = users[u] || {};
    users[u].nomeCompleto = f.nome || f.nomeCompleto || u;
    users[u].pis = f.pis || "";
    users[u].codigo = f.codigo || "";
    users[u].cargo = f.cargo || "";
    users[u].setor = f.setor || "";
    users[u].localTrabalho = f.local_trabalho || f.localTrabalho || "";
    users[u].role = (f.role || "operacional").toLowerCase();
    users[u].escalaSemanal = {
      1: f.escSeg || "08:00",
      2: f.escTer || "08:00",
      3: f.escQua || "08:00",
      4: f.escQui || "08:00",
      5: f.escSex || "08:00",
      6: f.escSab || "04:00",
      0: f.escDom || "FOLGA"
    };
    users[u].escalaMensal = users[u].escalaMensal || {};
  }catch(e){
    console.error(e);
  }
}

async function gerarRelatorioMensal(){
  const u = document.getElementById("funcionarioSelect").value;
  if(!u || !dataInicio.value) return;

  await garantirFuncionarioCarregado_(u);

  const tipo = document.getElementById("tipoRelatorio").value;
  const registros = JSON.parse(localStorage.getItem("registros")||"{}")[u] || {};
  const escSem = users[u]?.escalaSemanal || {};

  let totalPeriodo=0;
  let totalAtestadosMin = 0;
  let totalAfastamentosMin = 0;
  let totalAtrasosFaltasMin = 0;

  let html=`<h3>Cart√£o de Ponto - ${users[u]?.nomeCompleto || u}</h3>`;
  html+=`<p>C√≥digo: ${users[u]?.codigo || ""} | PIS: ${users[u]?.pis || ""} | Cargo: ${users[u]?.cargo || ""} | Setor: ${users[u]?.setor || ""} | Local: ${users[u]?.localTrabalho || ""}</p>`;
  html+=`<p>Per√≠odo: ${dataInicio.value} at√© ${dataFim.value || dataInicio.value}</p>`;
  html+=`<table id="tabelaRelatorio"><tr>
  <th>Data</th><th>Dia</th><th>Entrada</th><th>Sa√≠da Almo√ßo</th><th>Retorno</th><th>Sa√≠da</th><th>Total</th><th>Cr√©dito</th>`;
  if(tipo==="comGeo") html+=`<th>Geo Entrada</th><th>Geo Sa√≠da Almo√ßo</th><th>Geo Retorno</th><th>Geo Sa√≠da</th>`;
  html+="</tr>";

  const inicio = new Date(dataInicio.value);
  const fim = dataFim.value ? new Date(dataFim.value) : inicio;
  let currentDate = new Date(inicio);

  while(currentDate <= fim){
    const dia = String(currentDate.getDate()).padStart(2,"0");
    const mes = String(currentDate.getMonth()+1).padStart(2,"0");
    const ano = currentDate.getFullYear();
    const d = `${dia}/${mes}/${ano}`;
    const ddmm = `${dia}/${mes}`;

    dadosAtual = registros[d] || {};
    dataAtualRel = d;

    const JORNADA_PADRAO = 480; // 8h
    const weekday = currentDate.getDay(); // 0=Dom ... 6=S√°b
    const escStr = escSem[weekday] || "";
    const jornadaEscala = cargaEscalaMin(escStr);
    const isFeriadoLista = feriados.includes(ddmm);

    let min = 0;

    const eventos = [
      dadosAtual.entrada_evento,
      dadosAtual.saidaAlmoco_evento,
      dadosAtual.retornoAlmoco_evento,
      dadosAtual.saida_evento
    ].filter(Boolean);
    const eventoDia = eventos[0] || "";

    const temTodasMarcacoes =
      dadosAtual.entrada &&
      dadosAtual.saidaAlmoco &&
      dadosAtual.retornoAlmoco &&
      dadosAtual.saida;

    const temAlgumaMarcacao =
      dadosAtual.entrada || dadosAtual.saidaAlmoco || dadosAtual.retornoAlmoco || dadosAtual.saida;

    const folgaProgramada = escStr && escStr.toString().trim().toUpperCase()==="FOLGA";

    if(!eventoDia){
      if(temTodasMarcacoes){
        min =
          (hm(dadosAtual.saidaAlmoco) - hm(dadosAtual.entrada)) +
          (hm(dadosAtual.saida) - hm(dadosAtual.retornoAlmoco));
      }
      if(isFeriadoLista) min = 0;
      if(!isFeriadoLista && folgaProgramada && !temAlgumaMarcacao) min = 0;
    } else {
      switch(eventoDia){
        case "Falta Justificada":
          min = -JORNADA_PADRAO;
          totalAtestadosMin += -min;
          break;
        case "Atestado M√©dico Dias":
          min = -JORNADA_PADRAO;
          totalAtestadosMin += -min;
          break;
        case "Atestado M√©dico Horas": {
          const minutosAtestado = dadosAtual.atestadoHorasMin || JORNADA_PADRAO;
          min = -minutosAtestado;
          totalAtestadosMin += minutosAtestado;
          break;
        }
        case "Falta Injustificada":
          min = -JORNADA_PADRAO;
          totalAtrasosFaltasMin += min;
          break;
        case "Falta Abonada":
          min = JORNADA_PADRAO;
          totalAtestadosMin += min;
          break;
        case "F√©rias":
        case "Licen√ßa Maternidade":
        case "Licen√ßa Paternidade":
        case "Licen√ßa INSS+15 D":
        case "Acidente de Trabalho":
          min = JORNADA_PADRAO;
          totalAfastamentosMin += min;
          break;
        case "Feriado":
          min = 0;
          break;
      }
    }

    totalPeriodo += min;

    let creditoMin = min - jornadaEscala;
    if(isFeriadoLista && temAlgumaMarcacao){
      creditoMin = 16 * 60;
    }

    let nomeDia=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"][weekday];
    if(isFeriadoLista) nomeDia="Feriado";

    let conteudoEntrada, conteudoSaidaAlm, conteudoRetorno, conteudoSaida;

    if(!isFeriadoLista && folgaProgramada && !temAlgumaMarcacao && !eventoDia){
      conteudoEntrada = "FOLGA";
      conteudoSaidaAlm = "FOLGA";
      conteudoRetorno  = "FOLGA";
      conteudoSaida    = "FOLGA";
    } else {
      conteudoEntrada   = campo(dadosAtual.entrada,"entrada");
      conteudoSaidaAlm  = campo(dadosAtual.saidaAlmoco,"saidaAlmoco");
      conteudoRetorno   = campo(dadosAtual.retornoAlmoco,"retornoAlmoco");
      conteudoSaida     = campo(dadosAtual.saida,"saida");
    }

    html+=`<tr>
      <td>${d}</td>
      <td>${nomeDia}</td>
      <td>${conteudoEntrada}</td>
      <td>${conteudoSaidaAlm}</td>
      <td>${conteudoRetorno}</td>
      <td>${conteudoSaida}</td>
      <td class="${min>=0?'verde':'vermelho'}">${fmt(min)}</td>
      <td class="${creditoMin>=0?'verde':'vermelho'}">${creditoMin!==0 ? fmt(creditoMin) : ""}</td>`;
    if(tipo==="comGeo"){
      html+=`<td>${dadosAtual.geoEntrada||""}</td>
             <td>${dadosAtual.geoSaidaAlmoco||""}</td>
             <td>${dadosAtual.geoRetorno||""}</td>
             <td>${dadosAtual.geoSaida||""}</td>`;
    }
    html+="</tr>";
    currentDate.setDate(currentDate.getDate()+1);
  }

  html+=`<tr><th colspan="6">TOTAL</th>
           <th class="${totalPeriodo>=0?'verde':'vermelho'}">${fmt(totalPeriodo)}</th>
           <th></th>
         </tr></table>`;

  html+=`<br><h4>Totais do Per√≠odo</h4>`;
  html+=`<p><strong>Total trabalhado (registros + justificativas positivas/negativas):</strong> ${fmt(totalPeriodo)}</p>`;
  html+=`<p><strong>Total de atestados</strong>: ${fmt(totalAtestadosMin)}</p>`;
  html+=`<p><strong>Total de afastamentos</strong>: ${fmt(totalAfastamentosMin)}</p>`;
  html+=`<p><strong>Total atrasos/faltas</strong>: ${fmt(totalAtrasosFaltasMin)}</p>`;
  html+=`<p>Assinatura do Funcion√°rio: _____________________</p>`;

  document.getElementById("cartaoFuncionario").innerHTML = html;
}

/** =========================================================
 *  EXCEL / PDF (mantidos do seu padr√£o)
 *  ========================================================= */
function gerarExcel(){
  const tabelaOriginal = document.querySelector("#tabelaRelatorio");
  if(!tabelaOriginal){
    alert("Gere o relat√≥rio do cart√£o de ponto antes de exportar para Excel.");
    return;
  }

  const opt = confirm("Deseja gerar o relat√≥rio AJUSTADO?\nOK = Ajustado\nCancelar = Original");
  const tabela = tabelaOriginal.cloneNode(true);

  if(!opt){
    [...tabela.querySelectorAll("td")].forEach(td=>{
      if(td.innerHTML.includes("Editar") || td.innerHTML.includes("‚ûï Ajustar")){
        td.innerHTML = "";
      }
    });
  } else {
    [...tabela.querySelectorAll("td")].forEach(td=>{
      td.innerHTML = td.innerHTML.replace(/ <button.*<\/button>/g,"");
    });
  }

  const wb = XLSX.utils.book_new();
  const linhas = [];
  const trs = tabela.querySelectorAll("tr");

  function excelSerialFromDMY(dd, mm, yyyy){
    const excelEpoch = Date.UTC(1899, 11, 30);
    const dtUTC = Date.UTC(yyyy, mm - 1, dd);
    return (dtUTC - excelEpoch) / 86400000;
  }

  trs.forEach((tr, rowIndex) => {
    const row = [];
    const cells = tr.querySelectorAll("th,td");

    cells.forEach((cell, colIndex) => {
      let txt = (cell.innerText || cell.textContent || "").trim();

      if(rowIndex > 0 && colIndex === 0){
        const m = txt.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if(m){
          const dd = parseInt(m[1],10);
          const mm = parseInt(m[2],10);
          const yyyy = parseInt(m[3],10);
          const serial = excelSerialFromDMY(dd, mm, yyyy);
          row.push(serial);
        } else row.push(txt);
      } else row.push(txt);
    });

    linhas.push(row);
  });

  const ws = XLSX.utils.aoa_to_sheet(linhas);

  const range = XLSX.utils.decode_range(ws["!ref"]);
  for(let r = 1; r <= range.e.r; r++){
    const addr = XLSX.utils.encode_cell({ c: 0, r: r });
    const cell = ws[addr];
    if(cell && typeof cell.v === "number"){
      cell.t = "n";
      cell.z = "dd/mm/yyyy";
    }
  }

  XLSX.utils.book_append_sheet(wb, ws, "Cart√£o de Ponto");
  XLSX.writeFile(wb, "cartao_ponto.xlsx");
}

function gerarPDFAdmin(){
  const opt = confirm("Deseja gerar o relat√≥rio AJUSTADO?\nOK = Ajustado\nCancelar = Original");
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF('p','mm','a4');

  const func = funcionarioSelect.value;
  const dados = JSON.parse(localStorage.getItem("registros")||"{}")[func] || {};

  let qtdFaltasInjustificadas = 0;
  if(dataInicio.value){
    const inicio = new Date(dataInicio.value);
    const fim = dataFim.value ? new Date(dataFim.value) : inicio;
    let currentDate = new Date(inicio);

    while(currentDate <= fim){
      const dia = String(currentDate.getDate()).padStart(2,"0");
      const mes = String(currentDate.getMonth()+1).padStart(2,"0");
      const ano = currentDate.getFullYear();
      const d = `${dia}/${mes}/${ano}`;

      const regDia = dados[d] || {};
      const eventosDia = [
        regDia.entrada_evento,
        regDia.saidaAlmoco_evento,
        regDia.retornoAlmoco_evento,
        regDia.saida_evento
      ].filter(Boolean);

      if(eventosDia.includes("Falta Injustificada")) qtdFaltasInjustificadas++;
      currentDate.setDate(currentDate.getDate()+1);
    }
  }

  doc.setFontSize(12);
  doc.text("RELAT√ìRIO MENSAL DE PONTO",105,10,{align:"center"});
  doc.setFontSize(9);
  doc.text(`Faltas Injustificadas (desconto f√©rias): ${qtdFaltasInjustificadas} dia(s)`, 200, 10, {align:"right"});

  doc.setFontSize(10);
  const u = func;
  doc.text(`Funcion√°rio: ${users[u]?.nomeCompleto || u}`,14,18);
  doc.text(`C√≥digo: ${users[u]?.codigo || ""}`,14,24);
  doc.text(`PIS: ${users[u]?.pis || ""}`,14,30);
  doc.text(`Per√≠odo: ${dataInicio.value} at√© ${dataFim.value || dataInicio.value}`,14,36);

  const tabela = document.querySelector("#tabelaRelatorio").cloneNode(true);
  if(!opt){
    [...tabela.querySelectorAll("td")].forEach(td=>{
      if(td.innerHTML.includes("Editar") || td.innerHTML.includes("‚ûï Ajustar")){
        td.innerHTML="";
      }
    });
  } else {
    [...tabela.querySelectorAll("td")].forEach(td=>{
      td.innerHTML = td.innerHTML.replace(/ <button.*<\/button>/g,"");
    });
  }

  doc.autoTable({startY:42, html:tabela});
  doc.text("Assinatura do Funcion√°rio: ______________________",14,doc.lastAutoTable.finalY+10);
  doc.save("cartao_ponto.pdf");
}

/** =========================================================
 *  ESCALA MENSAL (local)
 *  ========================================================= */
function abrirEscalaMensal(){
  const u = document.getElementById("funcionarioSelect").value;
  if(!u) return alert("Selecione um funcion√°rio");

  users[u] = users[u] || {};
  users[u].escalaMensal = users[u].escalaMensal || {};

  const conteudo = document.getElementById("conteudoEscala");
  conteudo.innerHTML = "";
  for(let i=1;i<=31;i++){
    const val = users[u].escalaMensal[i] || "";
    conteudo.innerHTML += `Dia ${i}: <input type="text" id="escala${i}" value="${val}" placeholder="HH:MM ou vazio"><br>`;
  }
  modalEscala.classList.remove("hidden");
}
function fecharEscalaMensal(){ modalEscala.classList.add("hidden"); }
function salvarEscalaMensal(){
  const u = document.getElementById("funcionarioSelect").value;
  if(!u) return;
  users[u] = users[u] || {};
  users[u].escalaMensal = users[u].escalaMensal || {};
  for(let i=1;i<=31;i++){
    users[u].escalaMensal[i] = document.getElementById(`escala${i}`).value.trim();
  }
  fecharEscalaMensal();
  alert("Escala mensal manual salva (neste navegador).");
}

/** =========================================================
 *  Inicializa√ß√£o
 *  ========================================================= */
restaurarSessaoSePossivel();
</script>
</body>
</html>
