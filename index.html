<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relógio de Ponto Eletrônico</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.19/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<style>
body{font-family:Inter;background:#f8fafc;margin:0}
header{background:#1e40af;color:#fff;padding:20px;font-size:16px}
.card{background:#fff;padding:25px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.05);margin:20px auto}
button{padding:6px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff;cursor:pointer;margin:2px}
button:hover{background:#1d4ed8}
.hidden{display:none}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:13px}
th{background:#f1f5f9}
.verde{color:green;font-weight:bold;}
.vermelho{color:red;font-weight:bold;}
input,select{padding:6px 8px;border:1px solid #cbd5e1;border-radius:10px}
</style>
</head>
<body>
<header>Bem-vindo, <span id="nomeUsuario"></span></header>

<!-- LOGIN -->
<div id="loginSection" class="card" style="max-width:400px">
  <h2>Login</h2>
  <input id="username" placeholder="Usuário" autocomplete="off"><br><br>
  <input id="password" type="password" placeholder="Senha" autocomplete="off"><br><br>
  <button id="btnLogin" onclick="login()">Entrar</button>
  <div id="loginMsg" style="margin-top:10px;color:#b91c1c;font-size:13px"></div>
</div>

<!-- OPERACIONAL -->
<div id="operacionalSection" class="hidden">
  <div class="card" style="max-width:600px">
    <h2>Registro de Ponto</h2>
    <div id="dataAtual"></div>
    <div id="horaAtual"></div>
    <hr>
    <div id="botoesRegistro"></div>
    <hr>
    <h3>Marcações do Dia</h3>
    <div id="registrosUsuario"></div>
    <hr>
    <button onclick="logout()">Sair</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminSection" class="hidden">
  <div class="card" style="max-width:1200px">
    <h2>Relatório – Cartão de Ponto</h2>
    <button onclick="abrirCadastroFuncionario()">Cadastro / Edição de Funcionário</button>
    <br><br>

    <select id="funcionarioSelect"></select>
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <select id="tipoRelatorio">
      <option value="simples">Relatório Simples</option>
      <option value="comGeo">Com Geolocalização</option>
    </select>
    <button onclick="gerarRelatorioMensal()">Gerar</button>
    <button onclick="gerarExcel()">Excel</button>
    <button onclick="gerarPDFAdmin()">PDF</button>
    <button onclick="logout()">Sair</button>

    <div id="cartaoFuncionario"></div>
  </div>
</div>

<!-- MODAL CADASTRO FUNCIONARIO -->
<div id="modalFuncionario" class="card hidden" style="max-width:500px">
  <h3>Cadastro / Edição de Funcionário</h3>

  <label>Código Funcionário:</label><br>
  <input id="novoCodigo" placeholder="Ex: 001"><br><br>

  <label>Nome Funcionário:</label><br>
  <input id="novoNome" placeholder="Nome completo"><br><br>

  <label>Usuário (login):</label><br>
  <input id="novoUser" placeholder="Usuário (login)"><br><br>

  <label>Senha:</label><br>
  <input id="novoPass" type="password" placeholder="Senha"><br><br>

  <label>Cargo:</label><br>
  <input id="novoCargo" placeholder="Cargo"><br><br>

  <label>PIS:</label><br>
  <input id="novoPis" placeholder="PIS"><br><br>

  <label>Depto / Setor:</label><br>
  <input id="novoDepto" placeholder="Departamento / Setor"><br><br>

  <label>Local de Trabalho:</label><br>
  <input id="novoLocal" placeholder="Local de trabalho"><br><br>

  <hr>
  <h4>Escala Semanal (carga diária)</h4>
  <p style="font-size:12px;margin-top:0">
    Informe HH:MM ou FOLGA. Ex: Seg-Sex 08:00, Sáb 04:00, Dom FOLGA.
  </p>

  <label>Segunda:</label><br><input id="escalaSeg" placeholder="08:00"><br><br>
  <label>Terça:</label><br><input id="escalaTer" placeholder="08:00"><br><br>
  <label>Quarta:</label><br><input id="escalaQua" placeholder="08:00"><br><br>
  <label>Quinta:</label><br><input id="escalaQui" placeholder="08:00"><br><br>
  <label>Sexta:</label><br><input id="escalaSex" placeholder="08:00"><br><br>
  <label>Sábado:</label><br><input id="escalaSab" placeholder="04:00 ou FOLGA"><br><br>
  <label>Domingo:</label><br><input id="escalaDom" placeholder="FOLGA"><br><br>

  <button onclick="salvarFuncionario()">Salvar</button>
  <button onclick="fecharCadastroFuncionario()">Cancelar</button>
</div>

<script>
/** ✅ COLE AQUI O LINK /exec DO SEU WEB APP */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwxBa-DDtruDJFQhBEPonsRnrv0jb2gB7etz9EsoEj9MGuXmDs0hJpab0Tv7zXoMgq/exec";

let currentUser = null;
let currentUserInfo = null; // dados vindos da planilha
let funcionariosCache = []; // lista para admin

const feriados = ["01/01","07/09","25/12"]; // mantenha e depois a gente amplia

function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function hm(h){ if(!h||!String(h).includes(":"))return 0; const [a,b]=String(h).split(":").map(Number); return a*60+b; }
function fmt(m){ const sign=m<0?"-":""; const abs=Math.abs(m); return sign+String(Math.floor(abs/60)).padStart(2,"0")+":"+String(abs%60).padStart(2,"0"); }
function brDate(d){ return String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0")+"/"+d.getFullYear(); }

async function post_(payload){
  const r = await fetch(SCRIPT_URL, {
    method:"POST",
    headers: {"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify(payload)
  });
  const t = await r.text();
  try { return JSON.parse(t); } catch { throw new Error("Resposta não-JSON: "+t.slice(0,200)); }
}

/** ================= LOGIN ================= */
async function login(){
  const u = username.value.trim();
  const p = password.value.trim();
  loginMsg.textContent = "";
  if(!u||!p){ loginMsg.textContent="Preencha usuário e senha."; return; }

  btnLogin.disabled = true; btnLogin.textContent = "Validando...";
  try{
    const res = await post_({tipo:"login", usuario:u, senha:p});
    if(res.status!=="ok"){
      loginMsg.textContent = res.message || "Login inválido";
      password.value = "";
      return;
    }
    currentUser = u;
    currentUserInfo = res.user;
    nomeUsuario.textContent = res.user.nomeCompleto || u;

    loginSection.classList.add("hidden");

    if((res.user.role||"").toLowerCase()==="admin"){
      adminSection.classList.remove("hidden");
      await preencherFuncionariosPlanilha_();
    } else {
      operacionalSection.classList.remove("hidden");
      mostrarDataHora();
      await mostrarRegistrosUsuarioHoje_();
    }
  }catch(e){
    console.error(e);
    loginMsg.textContent = "Erro de conexão com o WebApp (F12 > Console).";
  }finally{
    btnLogin.disabled=false; btnLogin.textContent="Entrar";
  }
}
function logout(){ location.reload(); }

function mostrarDataHora(){
  setInterval(()=>{
    const a=new Date();
    dataAtual.textContent="Data: "+a.toLocaleDateString();
    horaAtual.textContent="Hora: "+a.toLocaleTimeString();
  },1000);
}

/** ============ OPERACIONAL: registrar ponto na planilha ============ */
async function registrar(tipo){
  const agora=new Date();
  const hora=agora.toLocaleTimeString().slice(0,5);
  const dataBR=brDate(agora);

  navigator.geolocation.getCurrentPosition(
    async pos=>{
      const geo = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
      await salvarRegistroPlanilha_(tipo, hora, dataBR, geo);
    },
    async ()=>{
      await salvarRegistroPlanilha_(tipo, hora, dataBR, "Não registrada");
    }
  );
}

async function salvarRegistroPlanilha_(tipo, hora, dataBR, geo){
  const res = await post_({
    tipo:"registrarPonto",
    usuario: currentUser,
    tipoMarcacao: tipo,
    hora,
    dataBR,
    geo
  });
  if(res.status!=="ok") alert(res.message||"Falha ao registrar ponto na planilha.");
  await mostrarRegistrosUsuarioHoje_();
}

async function mostrarRegistrosUsuarioHoje_(){
  const hoje = new Date();
  const di = hoje.toISOString().slice(0,10);
  const df = di;

  const res = await post_({ tipo:"getCartao", usuario: currentUser, dataInicio: di, dataFim: df });
  const lista = (res.status==="ok") ? res.registros : [];
  const row = lista.find(x=>x.dataBR===brDate(hoje)) || {};

  registrosUsuario.innerHTML = "";
  botoesRegistro.innerHTML = "";

  ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(t=>{
    if(row[t]){
      registrosUsuario.innerHTML += `<div><strong>${capitalize(t)}:</strong> ${row[t]}</div>`;
    }
  });

  if(!row.entrada) botoesRegistro.innerHTML = `<button onclick="registrar('entrada')">Entrada</button>`;
  else if(!row.saidaAlmoco) botoesRegistro.innerHTML = `<button onclick="registrar('saidaAlmoco')">Saída Almoço</button>`;
  else if(!row.retornoAlmoco) botoesRegistro.innerHTML = `<button onclick="registrar('retornoAlmoco')">Retorno</button>`;
  else if(!row.saida) botoesRegistro.innerHTML = `<button onclick="registrar('saida')">Saída</button>`;
  else botoesRegistro.innerHTML = "✅ Jornada finalizada";
}

/** ============ ADMIN: listar funcionários via planilha ============ */
async function preencherFuncionariosPlanilha_(){
  const res = await post_({tipo:"listarFuncionarios"});
  if(res.status!=="ok"){ alert(res.message||"Erro ao listar funcionários"); return; }

  funcionariosCache = res.funcionarios || [];

  funcionarioSelect.innerHTML = "<option value=''>Selecionar Funcionário</option>";
  funcionariosCache.forEach(f=>{
    const opt = document.createElement("option");
    opt.value = f.usuario;
    opt.textContent = f.nomeCompleto || f.usuario;
    funcionarioSelect.appendChild(opt);
  });
}

/** ============ ADMIN: relatório lê da planilha ============ */
function feriadoNome_(ddmm){ return feriados.includes(ddmm); }

function cargaEscalaMin(escStr){
  if(!escStr) return 0;
  const t = String(escStr).trim().toUpperCase();
  if(t==="FOLGA") return 0;
  return hm(escStr);
}

function campoVisivel_(row, campo){
  // mostra hora se existir; se tiver evento mostra evento; se vazio, retorna botão Ajustar
  const valor = row[campo] || "";
  const evento = row[campo+"_evento"] || "";
  if(valor && !evento) return valor;
  if(evento) return evento + ` <button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${row.dataBR}','${campo}')">Editar</button>`;
  return `<button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${row.dataBR}','${campo}')">➕ Ajustar</button>`;
}

async function gerarRelatorioMensal(){
  const u = funcionarioSelect.value;
  if(!u || !dataInicio.value){ alert("Selecione funcionário e data início."); return; }

  const tipo = tipoRelatorio.value;
  const f = funcionariosCache.find(x=>x.usuario===u) || {};

  const res = await post_({ tipo:"getCartao", usuario:u, dataInicio:dataInicio.value, dataFim:(dataFim.value||dataInicio.value) });
  if(res.status!=="ok"){ alert(res.message||"Erro ao buscar cartão."); return; }

  // monta map por dataBR
  const map = {};
  (res.registros||[]).forEach(r=>{ map[r.dataBR]=r; });

  const ini = new Date(dataInicio.value+"T00:00:00");
  const fim = new Date((dataFim.value||dataInicio.value)+"T00:00:00");

  let html = `<h3>Cartão de Ponto - ${f.nomeCompleto || u}</h3>`;
  html += `<p>Código: ${f.codigo||""} | PIS: ${f.pis||""} | Cargo: ${f.cargo||""} | Depto: ${f.depto||""} | Local: ${f.localTrabalho||""}</p>`;
  html += `<p>Período: ${dataInicio.value} até ${dataFim.value||dataInicio.value}</p>`;

  html += `<table id="tabelaRelatorio"><tr>
    <th>Data</th><th>Dia</th><th>Entrada</th><th>Saída Almoço</th><th>Retorno</th><th>Saída</th><th>Total</th><th>Crédito</th>`;
  if(tipo==="comGeo") html += `<th>Geo Entrada</th><th>Geo Saída Almoço</th><th>Geo Retorno</th><th>Geo Saída</th>`;
  html += `</tr>`;

  let totalTrabalhado = 0;

  const escalaSem = f.escalaSemanal || {1:"08:00",2:"08:00",3:"08:00",4:"08:00",5:"08:00",6:"04:00",0:"FOLGA"};

  for(let d = new Date(ini); d <= fim; d.setDate(d.getDate()+1)){
    const dataBR = brDate(d);
    const ddmm = dataBR.slice(0,5);
    const weekday = d.getDay();
    const nomeDia = feriadoNome_(ddmm) ? "Feriado" : ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"][weekday];

    const row = map[dataBR] || { dataBR };

    // escala do dia
    const escStr = escalaSem[weekday] || "";
    const jornadaEscala = cargaEscalaMin(escStr);

    // horas trabalhadas reais
    let trabMin = 0;
    if(row.entrada && row.saidaAlmoco && row.retornoAlmoco && row.saida){
      trabMin = (hm(row.saidaAlmoco)-hm(row.entrada)) + (hm(row.saida)-hm(row.retornoAlmoco));
      if(trabMin < 0) trabMin = 0;
    }

    // crédito simples: trabalhado - escala (feriado se trabalhou = crédito = trabalhado)
    let credito = 0;
    if(feriadoNome_(ddmm)){
      credito = trabMin ? trabMin : 0;
    } else {
      credito = trabMin - jornadaEscala;
    }

    totalTrabalhado += trabMin;

    html += `<tr>
      <td>${dataBR}</td>
      <td>${nomeDia}</td>
      <td>${campoVisivel_(row,"entrada")}</td>
      <td>${campoVisivel_(row,"saidaAlmoco")}</td>
      <td>${campoVisivel_(row,"retornoAlmoco")}</td>
      <td>${campoVisivel_(row,"saida")}</td>
      <td class="${trabMin>=0?'verde':'vermelho'}">${trabMin?fmt(trabMin):""}</td>
      <td class="${credito>=0?'verde':'vermelho'}">${credito?fmt(credito):""}</td>`;

    if(tipo==="comGeo"){
      html += `<td>${row.geoEntrada||""}</td><td>${row.geoSaidaAlmoco||""}</td><td>${row.geoRetornoAlmoco||""}</td><td>${row.geoSaida||""}</td>`;
    }

    html += `</tr>`;
  }

  html += `<tr><th colspan="6">TOTAL HORAS TRABALHADAS</th><th class="verde">${fmt(totalTrabalhado)}</th><th></th></tr>`;
  html += `</table><p>Assinatura do Funcionário: _____________________</p>`;

  cartaoFuncionario.innerHTML = html;
}

/** ============ AJUSTE (admin) -> salva na planilha ============ */
const justificativas = [
  "Nenhum","FOLGA","Férias","Falta Justificada","Falta Injustificada","Falta Abonada",
  "Atestado Médico Dias","Atestado Médico Horas","Licença Maternidade","Licença Paternidade",
  "Licença INSS+15 D","Acidente de Trabalho","Feriado"
];

function abrirAjuste(usuario, dataBR, campo){
  const popup = document.createElement("div");
  popup.style.position="fixed";
  popup.style.top="50%";
  popup.style.left="50%";
  popup.style.transform="translate(-50%,-50%)";
  popup.style.background="#fff";
  popup.style.padding="20px";
  popup.style.border="1px solid #333";
  popup.style.zIndex=1000;

  popup.innerHTML = `
    <h3>Ajustar ${campo} (${dataBR})</h3>
    <label>Horas (HH:MM):<br><input id="ajHoras" placeholder="HH:MM"></label><br><br>
    <label>Justificativa:<br>
      <select id="ajEvento">
        <option value="">--Escolha--</option>
        ${justificativas.map(j=>`<option value="${j}">${j}</option>`).join("")}
      </select>
    </label><br><br>
    <button id="okBtn">Ok</button>
    <button id="cancelBtn">Cancelar</button>
  `;

  document.body.appendChild(popup);

  popup.querySelector("#cancelBtn").onclick = ()=>popup.remove();
  popup.querySelector("#okBtn").onclick = async ()=>{
    const horas = popup.querySelector("#ajHoras").value.trim();
    const evento = popup.querySelector("#ajEvento").value.trim();

    try{
      const res = await post_({ tipo:"salvarAjuste", usuario, dataBR, campo, horas, evento });
      if(res.status!=="ok") alert(res.message||"Falha ao salvar ajuste.");
      popup.remove();
      await gerarRelatorioMensal();
    }catch(e){
      console.error(e);
      alert("Erro ao salvar ajuste (F12 > Console).");
    }
  };
}

/** ============ Exportações (usam a tabela renderizada) ============ */
function gerarExcel(){
  const tabela = document.querySelector("#tabelaRelatorio");
  if(!tabela){ alert("Gere o relatório antes."); return; }
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.table_to_sheet(tabela);
  XLSX.utils.book_append_sheet(wb, ws, "Cartão de Ponto");
  XLSX.writeFile(wb, "cartao_ponto.xlsx");
}

function gerarPDFAdmin(){
  const tabela = document.querySelector("#tabelaRelatorio");
  if(!tabela){ alert("Gere o relatório antes."); return; }
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF('p','mm','a4');
  doc.setFontSize(12);
  doc.text("RELATÓRIO MENSAL DE PONTO",105,10,{align:"center"});
  doc.autoTable({startY:18, html:tabela});
  doc.save("cartao_ponto.pdf");
}

/** ============ Cadastro funcionário (admin) ============ */
function abrirCadastroFuncionario(){
  modalFuncionario.classList.remove("hidden");
  // limpa
  novoCodigo.value=""; novoNome.value=""; novoUser.value=""; novoPass.value="";
  novoCargo.value=""; novoPis.value=""; novoDepto.value=""; novoLocal.value="";
  escalaSeg.value="08:00"; escalaTer.value="08:00"; escalaQua.value="08:00";
  escalaQui.value="08:00"; escalaSex.value="08:00"; escalaSab.value="04:00"; escalaDom.value="FOLGA";
}
function fecharCadastroFuncionario(){ modalFuncionario.classList.add("hidden"); }

async function salvarFuncionario(){
  const payload = {
    tipo:"salvarFuncionario",
    codigo: novoCodigo.value.trim(),
    nome: novoNome.value.trim(),
    usuario: novoUser.value.trim(),
    senha: novoPass.value.trim(),
    cargo: novoCargo.value.trim(),
    pis: novoPis.value.trim(),
    depto: novoDepto.value.trim(),
    localTrabalho: novoLocal.value.trim(),
    role: "operacional",
    escSeg: (escalaSeg.value.trim()||"08:00"),
    escTer: (escalaTer.value.trim()||"08:00"),
    escQua: (escalaQua.value.trim()||"08:00"),
    escQui: (escalaQui.value.trim()||"08:00"),
    escSex: (escalaSex.value.trim()||"08:00"),
    escSab: (escalaSab.value.trim()||"04:00"),
    escDom: (escalaDom.value.trim()||"FOLGA")
  };

  if(!payload.usuario || !payload.senha || !payload.nome || !payload.pis){
    alert("Obrigatório: Nome, Usuário, Senha, PIS");
    return;
  }

  const res = await post_(payload);
  if(res.status!=="ok"){ alert(res.message||"Erro ao salvar funcionário."); return; }

  alert(res.message||"Salvo!");
  fecharCadastroFuncionario();
  await preencherFuncionariosPlanilha_();
}
</script>
</body>
</html>
