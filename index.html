<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Rel√≥gio de Ponto Eletr√¥nico</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.19/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<style>
body{font-family:Inter;background:#f8fafc;margin:0}
header{background:#1e40af;color:#fff;padding:20px;font-size:16px}
.card{background:#fff;padding:25px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.05);margin:20px auto}
button{padding:6px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff;cursor:pointer;margin:2px}
button:hover{background:#1d4ed8}
.hidden{display:none}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:13px}
th{background:#f1f5f9}
.verde{color:green;font-weight:bold;}
.vermelho{color:red;font-weight:bold;}
input,select{padding:4px 6px;margin:2px 0;}
</style>
</head>
<body>
<header>
  Bem-vindo, <span id="nomeUsuario"></span>
</header>

<!-- LOGIN -->
<div id="loginSection" class="card" style="max-width:400px">
  <h2>Login</h2>
  <input id="username" placeholder="Usu√°rio"><br><br>
  <input id="password" type="password" placeholder="Senha"><br><br>
  <button onclick="login()">Entrar</button>
</div>

<!-- OPERACIONAL -->
<div id="operacionalSection" class="hidden">
  <div class="card" style="max-width:600px">
    <h2>Registro de Ponto</h2>
    <div id="dataAtual"></div>
    <div id="horaAtual"></div>
    <hr>
    <div id="botoesRegistro"></div>
    <hr>
    <h3>Marca√ß√µes do Dia</h3>
    <div id="registrosUsuario"></div>
    <hr>
    <button onclick="logout()">Sair</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminSection" class="hidden">
  <div class="card" style="max-width:1200px">
    <h2>Relat√≥rio ‚Äì Cart√£o de Ponto</h2>
    <button onclick="abrirCadastroFuncionario()">Cadastro / Edi√ß√£o de Funcion√°rio</button>
    <button onclick="abrirEscalaMensal()">Editar Escala Mensal</button><br><br>

    <select id="funcionarioSelect" onchange="gerarRelatorioMensal()"></select>
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <select id="tipoRelatorio">
      <option value="simples">Relat√≥rio Simples</option>
      <option value="comGeo">Com Geolocaliza√ß√£o</option>
    </select>
    <button onclick="gerarRelatorioMensal()">Gerar</button>
    <button onclick="gerarExcel()">Excel</button>
    <button onclick="gerarPDFAdmin()">PDF</button>
    <button onclick="logout()">Sair</button>
    <div id="cartaoFuncionario"></div>
  </div>
</div>

<!-- MODAL CADASTRO FUNCIONARIO -->
<div id="modalFuncionario" class="card hidden" style="max-width:500px">
  <h3>Cadastro / Edi√ß√£o de Funcion√°rio</h3>

  <label>C√≥digo Funcion√°rio:<br>
    <input id="novoCodigo" placeholder="C√≥digo">
  </label><br>

  <label>Nome Funcion√°rio:<br>
    <input id="novoNome" placeholder="Nome completo">
  </label><br>

  <label>Usu√°rio (login):<br>
    <input id="novoUser" placeholder="Usu√°rio">
  </label><br>

  <label>Senha:<br>
    <input id="novoPass" type="password" placeholder="Senha">
  </label><br>

  <label>Cargo:<br>
    <input id="novoCargo" placeholder="Cargo/Fun√ß√£o">
  </label><br>

  <label>PIS:<br>
    <input id="novoPis" placeholder="PIS">
  </label><br>

  <label>Depto/Setor:<br>
    <input id="novoSetor" placeholder="Departamento / Setor">
  </label><br>

  <label>Local de Trabalho:<br>
    <input id="novoLocal" placeholder="Local de trabalho">
  </label><br>

  <p><strong>Escala padr√£o semanal do funcion√°rio</strong><br>
    Digite <strong>HH:MM</strong> para a carga di√°ria ou <strong>FOLGA</strong>.
  </p>

  <label>Segunda-feira:<br>
    <input id="escSeg" placeholder="HH:MM ou FOLGA" value="08:00">
  </label><br>

  <label>Ter√ßa-feira:<br>
    <input id="escTer" placeholder="HH:MM ou FOLGA" value="08:00">
  </label><br>

  <label>Quarta-feira:<br>
    <input id="escQua" placeholder="HH:MM ou FOLGA" value="08:00">
  </label><br>

  <label>Quinta-feira:<br>
    <input id="escQui" placeholder="HH:MM ou FOLGA" value="08:00">
  </label><br>

  <label>Sexta-feira:<br>
    <input id="escSex" placeholder="HH:MM ou FOLGA" value="08:00">
  </label><br>

  <label>S√°bado:<br>
    <input id="escSab" placeholder="HH:MM ou FOLGA" value="04:00">
  </label><br>

  <label>Domingo:<br>
    <input id="escDom" placeholder="HH:MM ou FOLGA" value="FOLGA">
  </label><br><br>

  <button onclick="salvarFuncionario()">Salvar</button>
  <button onclick="fecharCadastroFuncionario()">Cancelar</button>
</div>

<!-- MODAL ESCALA MENSAL -->
<div id="modalEscala" class="card hidden" style="max-width:600px;max-height:500px;overflow:auto">
  <h3>Editar Escala Mensal (manual)</h3>
  <p>Formato HH:MM por dia (opcional ‚Äì usado se quiser sobrescrever a escala semanal)</p>
  <div id="conteudoEscala"></div>
  <button onclick="salvarEscalaMensal()">Salvar Escala</button>
  <button onclick="fecharEscalaMensal()">Cancelar</button>
</div>

<script>
/************* CONFIG *************/
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyYhU-CW0rAHd139ZZUBV6ATRl43s8iok2hQ3VxSZv2_Ozyc8ew3y6DsRLpfVkBFJTQ/exec";

/************* API *************/
async function apiPost(payload){
  const r = await fetch(WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const data = await r.json();
  return data;
}

/************* DADOS (vem da planilha) *************/
let users = {};             // map por usuario_login
let currentUser = null;
let currentUserObj = null;

let dadosAtual = {}, dataAtualRel = "";
const feriados=["01/01","07/09","25/12"];

const justificativas = [
  "Nenhum","F√©rias","Falta Justificada","Falta Injustificada","Falta Abonada",
  "Atestado M√©dico Dias","Atestado M√©dico Horas",
  "Licen√ßa Maternidade","Licen√ßa Paternidade","Licen√ßa INSS+15 D","Acidente de Trabalho","Feriado"
];

/************* HELPERS *************/
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function hm(h){
  if(!h || typeof h!=="string" || !h.includes(":")) return 0;
  const[x,y]=h.split(":").map(Number);
  return x*60+y;
}
function fmt(m){
  const sign = m<0 ? "-" : "";
  const abs = Math.abs(m);
  const h = String(Math.floor(abs/60)).padStart(2,"0");
  const mm = String(abs%60).padStart(2,"0");
  return sign + h + ":" + mm;
}
function cargaEscalaMin(escStr){
  if(!escStr) return 0;
  const s = escStr.toString().toUpperCase().trim();
  if(s==="FOLGA") return 0;
  if(/^\d{2}:\d{2}$/.test(s)) return hm(s);
  if(s.includes("=")){
    const partes = s.split("=");
    const carga = partes[partes.length-1].trim();
    if(/^\d{2}:\d{2}$/.test(carga)) return hm(carga);
  }
  return 0;
}

/************* CARREGAR USU√ÅRIOS *************/
async function carregarUsuarios(){
  const res = await apiPost({tipo:"listarUsuarios"});
  if(res.status !== "ok") throw new Error(res.message || "Erro ao listar usu√°rios");

  const map = {};
  (res.users || []).forEach(u=>{
    const key = (u.usuario_login || "").trim();
    if(!key) return;

    const esc = {
      1: (u.escSeg || "08:00"),
      2: (u.escTer || "08:00"),
      3: (u.escQua || "08:00"),
      4: (u.escQui || "08:00"),
      5: (u.escSex || "08:00"),
      6: (u.escSab || "04:00"),
      0: (u.escDom || "FOLGA")
    };

    map[key] = {
      ...u,
      nomeCompleto: u.nomeCompleto || u.nome || key,
      localTrabalho: u.localTrabalho || u.local_trabalho || "",
      escalaMensal: {},
      escalaSemanal: esc
    };
  });

  users = map;
}

/************* LOGIN *************/
async function login(){
  const u = username.value.trim();
  const p = password.value.trim();
  if(!u || !p){
    alert("Preencha usu√°rio e senha.");
    return;
  }

  const res = await apiPost({tipo:"login", usuario:u, senha:p});
  if(res.status !== "ok"){
    alert(res.message || "Login inv√°lido");
    return;
  }

  // carrega base de usu√°rios (para admin/relat√≥rios)
  await carregarUsuarios();

  currentUser = u;
  currentUserObj = users[u] || res.user || {usuario_login:u};

  nomeUsuario.textContent = currentUserObj.nomeCompleto || u;
  loginSection.classList.add("hidden");

  const role = String(currentUserObj.role || res.user?.role || "").trim();
  if(role === "admin"){
    adminSection.classList.remove("hidden");
    preencherFuncionarios();
  }else{
    operacionalSection.classList.remove("hidden");
    mostrarDataHora();
    await mostrarRegistrosUsuario();
  }
}

function logout(){ location.reload(); }

/************* OPERACIONAL *************/
function registrar(tipo){
  const agora=new Date();
  const hora=agora.toLocaleTimeString().slice(0,5);
  const data=agora.toLocaleDateString(); // dd/mm/aaaa

  navigator.geolocation.getCurrentPosition(
    pos=> salvarRegistro(tipo,hora,data,`${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`),
    ()=> salvarRegistro(tipo,hora,data,"N√£o registrada")
  );
}

async function salvarRegistro(tipo,hora,data,geo){
  const res = await apiPost({
    tipo:"registroPonto",
    usuario_login: currentUser,
    data: data,
    marcacao: tipo,
    hora: hora,
    geo: geo
  });

  if(res.status !== "ok"){
    alert(res.message || "Erro ao salvar registro na planilha");
    return;
  }

  await mostrarRegistrosUsuario();
}

function mostrarDataHora(){
  setInterval(()=>{
    const a=new Date();
    dataAtual.textContent="Data: "+a.toLocaleDateString();
    horaAtual.textContent="Hora: "+a.toLocaleTimeString();
  },1000);
}

async function mostrarRegistrosUsuario(){
  const hoje=new Date().toLocaleDateString();
  const res = await apiPost({tipo:"getDia", usuario_login: currentUser, data: hoje});
  if(res.status !== "ok"){
    registrosUsuario.innerHTML = "Erro ao carregar dia: " + (res.message||"");
    return;
  }
  const r = res.dia || {};

  registrosUsuario.innerHTML="";
  botoesRegistro.innerHTML="";
  ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(t=>{
    if(r[t]){
      registrosUsuario.innerHTML+=`<div><strong>${capitalize(t)}:</strong> ${r[t]} <button style="font-size:11px" onclick="gerarComprovante('${t}')">üìÑ PDF</button></div>`;
    }
  });

  if(!r.entrada) botoesRegistro.innerHTML=`<button onclick="registrar('entrada')">Entrada</button>`;
  else if(!r.saidaAlmoco) botoesRegistro.innerHTML=`<button onclick="registrar('saidaAlmoco')">Sa√≠da Almo√ßo</button>`;
  else if(!r.retornoAlmoco) botoesRegistro.innerHTML=`<button onclick="registrar('retornoAlmoco')">Retorno</button>`;
  else if(!r.saida) botoesRegistro.innerHTML=`<button onclick="registrar('saida')">Sa√≠da</button>`;
  else botoesRegistro.innerHTML="‚úÖ Jornada finalizada";
}

/************* COMPROVANTE INDIVIDUAL *************/
async function gerarComprovante(tipo){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  const hoje=new Date().toLocaleDateString();

  const res = await apiPost({tipo:"getDia", usuario_login: currentUser, data: hoje});
  const r = (res.status==="ok" ? res.dia : {}) || {};

  const hora=r[tipo]||"";
  const geoKey = ({
    entrada: "geoEntrada",
    saidaAlmoco: "geoSaidaAlmoco",
    retornoAlmoco: "geoRetornoAlmoco",
    saida: "geoSaida"
  })[tipo] || ("geo"+capitalize(tipo));

  const geo=r[geoKey]||"";

  doc.setFontSize(14);
  doc.text("COMPROVANTE DE REGISTRO DE PONTO",105,15,{align:"center"});
  doc.setFontSize(11);
  doc.text(`Colaborador: ${users[currentUser]?.nomeCompleto || currentUser}`,14,30);
  doc.text(`PIS: ${users[currentUser]?.pis||""}`,14,36);
  doc.text(`Data: ${hoje}`,14,42);
  doc.text(`Tipo de Marca√ß√£o: ${capitalize(tipo)}`,14,48);
  doc.text(`Hor√°rio: ${hora}`,14,54);
  doc.text(`Geolocaliza√ß√£o: ${geo}`,14,60);
  doc.save(`comprovante_${tipo}_${hoje}.pdf`);
}

/************* AJUSTE (salva no Sheets) *************/
function campo(valor, c, adminView = true){
  const vazio = !valor || valor === "-";
  const evento = dadosAtual[c+"_evento"];

  if(!vazio && !evento){
    if(adminView){
      return valor + (dadosAtual[c+"_editado"]
        ? ` <button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${dataAtualRel}','${c}')">Editar</button>`
        : "");
    }
    return valor;
  }

  if(evento){
    if(adminView){
      return evento +
        ` <button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${dataAtualRel}','${c}')">Editar</button>`;
    }
    return evento;
  }

  if(adminView){
    return `<button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${dataAtualRel}','${c}')">‚ûï Ajustar</button>`;
  }
  return "";
}

async function abrirAjuste(u,d,c){
  const resGet = await apiPost({tipo:"getDia", usuario_login:u, data:d});
  if(resGet.status !== "ok"){
    alert(resGet.message || "Erro ao carregar dia");
    return;
  }
  const atual = resGet.dia || {};

  let popup = document.createElement("div");
  popup.style.position="fixed";
  popup.style.top="50%";
  popup.style.left="50%";
  popup.style.transform="translate(-50%,-50%)";
  popup.style.background="#fff";
  popup.style.padding="20px";
  popup.style.border="1px solid #333";
  popup.style.zIndex=1000;

  popup.innerHTML=`
    <h3>Ajustar ${c}</h3>
    <label>Horas: <input type="text" id="inputHoras" placeholder="HH:MM" value="${atual[c]||""}"></label><br><br>
    <label>Justificar:
      <select id="selectJustificacao">
        <option value="">--Escolha--</option>
        ${justificativas.map(j=>`<option value="${j}" ${String(atual[c+"_evento"]||"")===j?'selected':''}>${j}</option>`).join("")}
      </select>
    </label><br><br>
    <button id="okBtn">Ok</button>
    <button id="cancelBtn">Cancelar</button>
  `;
  document.body.appendChild(popup);

  popup.querySelector("#okBtn").onclick = async ()=>{
    const h = popup.querySelector("#inputHoras").value.trim();
    const ev = popup.querySelector("#selectJustificacao").value;

    if(ev === "Nenhum"){
      ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
        delete atual[campoNome+"_evento"];
        delete atual[campoNome+"_editado"];
        if(atual[campoNome] === "-" || atual[campoNome] === "" || atual[campoNome] == null){
          delete atual[campoNome];
        }
      });
      delete atual.atestadoHorasMin;

      const resSave = await apiPost({tipo:"salvarDia", usuario_login:u, data:d, dia: atual});
      if(resSave.status!=="ok") alert(resSave.message||"Erro ao salvar ajuste");
      popup.remove();
      await gerarRelatorioMensal();
      return;
    }

    if(ev === "Atestado M√©dico Dias"){
      const intervalo = prompt("Informe o intervalo do atestado (formato: dd/mm/aaaa - dd/mm/aaaa):", d+" - "+d);
      if(intervalo){
        const partes = intervalo.split("-");
        if(partes.length===2){
          const iniStr = partes[0].trim();
          const fimStr = partes[1].trim();
          const [di,mi,ai] = iniStr.split("/").map(Number);
          const [df,mf,af] = fimStr.split("/").map(Number);
          if(di&&mi&&ai&&df&&mf&&af){
            let dataIni = new Date(ai,mi-1,di);
            let dataFim = new Date(af,mf-1,df);
            if(dataIni > dataFim){ const tmp=dataIni; dataIni=dataFim; dataFim=tmp; }

            let cursor = new Date(dataIni);
            while(cursor <= dataFim){
              const cdia = String(cursor.getDate()).padStart(2,"0");
              const cmes = String(cursor.getMonth()+1).padStart(2,"0");
              const cano = cursor.getFullYear();
              const chave = `${cdia}/${cmes}/${cano}`;

              const resDia = await apiPost({tipo:"getDia", usuario_login:u, data:chave});
              const reg = (resDia.status==="ok" ? resDia.dia : {}) || {};

              ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
                reg[campoNome] = "-";
                reg[campoNome+"_evento"] = ev;
                reg[campoNome+"_editado"] = true;
              });
              delete reg.atestadoHorasMin;

              await apiPost({tipo:"salvarDia", usuario_login:u, data:chave, dia: reg});
              cursor.setDate(cursor.getDate()+1);
            }
            popup.remove();
            await gerarRelatorioMensal();
            return;
          }
        }
      }
    }

    if(ev === "Atestado M√©dico Horas"){
      const dataAtestadoStr = prompt("Data do atestado (dd/mm/aaaa):", d);
      if(!dataAtestadoStr){ popup.remove(); return; }
      const [ddia,dmes,dano] = dataAtestadoStr.split("/").map(Number);
      if(!ddia||!dmes||!dano){ popup.remove(); return; }
      const dataAtestadoKey = `${String(ddia).padStart(2,"0")}/${String(dmes).padStart(2,"0")}/${dano}`;
      const hIni = prompt("Hora IN√çCIO do atestado (HH:MM):","08:00");
      const hFim = prompt("Hora FIM do atestado (HH:MM):","10:00");
      if(!hIni || !hFim){ popup.remove(); return; }
      const minutosAtestado = Math.max(0, hm(hFim) - hm(hIni));

      const resDia = await apiPost({tipo:"getDia", usuario_login:u, data:dataAtestadoKey});
      const regA = (resDia.status==="ok" ? resDia.dia : {}) || {};

      ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
        regA[campoNome]="-";
        regA[campoNome+"_evento"]=ev;
        regA[campoNome+"_editado"]=true;
      });
      regA.atestadoHorasMin = minutosAtestado;

      const resSave = await apiPost({tipo:"salvarDia", usuario_login:u, data:dataAtestadoKey, dia: regA});
      if(resSave.status!=="ok") alert(resSave.message||"Erro ao salvar atestado");
      popup.remove();
      await gerarRelatorioMensal();
      return;
    }

    if(h){
      atual[c]=h;
      atual[c+"_evento"]="";
      atual[c+"_editado"]=true;
      delete atual.atestadoHorasMin;
    } else if(ev){
      ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
        atual[campoNome]="-";
        atual[campoNome+"_evento"]=ev;
        atual[campoNome+"_editado"]=true;
      });
      delete atual.atestadoHorasMin;
    }

    const resSave = await apiPost({tipo:"salvarDia", usuario_login:u, data:d, dia: atual});
    if(resSave.status!=="ok") alert(resSave.message||"Erro ao salvar ajuste");
    popup.remove();
    await gerarRelatorioMensal();
  };

  popup.querySelector("#cancelBtn").onclick=()=> popup.remove();
}

/************* ADMIN *************/
function preencherFuncionarios(){
  const select=document.getElementById("funcionarioSelect");
  select.innerHTML="<option value=''>Selecionar Funcion√°rio</option>";
  Object.keys(users).forEach(u=>{
    if(String(users[u].role||"").trim()==="operacional"){
      const option=document.createElement("option");
      option.value=u; option.textContent=users[u].nomeCompleto || u;
      select.appendChild(option);
    }
  });
}

/************* RELAT√ìRIO (l√™ do Sheets) *************/
async function gerarRelatorioMensal(){
  const u=document.getElementById("funcionarioSelect").value;
  if(!u || !dataInicio.value) return;

  const tipo=document.getElementById("tipoRelatorio").value;

  const res = await apiPost({
    tipo:"getPeriodo",
    usuario_login: u,
    dataInicio: dataInicio.value,
    dataFim: dataFim.value || dataInicio.value
  });

  if(res.status !== "ok"){
    alert(res.message || "Erro ao carregar per√≠odo");
    return;
  }

  const registros = res.registros || {};
  const escSem = users[u].escalaSemanal || {};

  let totalPeriodo=0;
  let totalAtestadosMin = 0;
  let totalAfastamentosMin = 0;
  let totalAtrasosFaltasMin = 0;

  let html=`<h3>Cart√£o de Ponto - ${users[u].nomeCompleto || u}</h3>`;
  html+=`<p>PIS: ${users[u].pis || ""} | Cargo: ${users[u].cargo || ""} | Setor: ${users[u].setor || ""} | Local: ${users[u].localTrabalho || ""}</p>`;
  html+=`<p>Per√≠odo: ${dataInicio.value} at√© ${dataFim.value || dataInicio.value}</p>`;
  html+=`<table id="tabelaRelatorio"><tr>
    <th>Data</th><th>Dia</th><th>Entrada</th><th>Sa√≠da Almo√ßo</th><th>Retorno</th><th>Sa√≠da</th><th>Total</th><th>Cr√©dito</th>`;
  if(tipo==="comGeo") html+=`<th>Geo Entrada</th><th>Geo Sa√≠da Almo√ßo</th><th>Geo Retorno</th><th>Geo Sa√≠da</th>`;
  html+="</tr>";

  const inicio = new Date(dataInicio.value);
  const fim = dataFim.value ? new Date(dataFim.value) : inicio;
  let currentDate = new Date(inicio);

  while(currentDate <= fim){
    const dia = String(currentDate.getDate()).padStart(2,"0");
    const mes = String(currentDate.getMonth()+1).padStart(2,"0");
    const ano = currentDate.getFullYear();
    const d = `${dia}/${mes}/${ano}`;
    const ddmm = `${dia}/${mes}`;

    dadosAtual = registros[d] || {};
    dataAtualRel = d;

    const JORNADA_PADRAO = 480;

    const weekday = currentDate.getDay();
    const escStr = escSem[weekday] || "";
    const jornadaEscala = cargaEscalaMin(escStr);
    const isFeriadoLista = feriados.includes(ddmm);

    let min = 0;

    const eventos = [
      dadosAtual.entrada_evento,
      dadosAtual.saidaAlmoco_evento,
      dadosAtual.retornoAlmoco_evento,
      dadosAtual.saida_evento
    ].filter(Boolean);
    const eventoDia = eventos[0] || "";

    const temTodasMarcacoes =
      dadosAtual.entrada &&
      dadosAtual.saidaAlmoco &&
      dadosAtual.retornoAlmoco &&
      dadosAtual.saida;

    const temAlgumaMarcacao =
      dadosAtual.entrada || dadosAtual.saidaAlmoco || dadosAtual.retornoAlmoco || dadosAtual.saida;

    const folgaProgramada = escStr && escStr.toString().trim().toUpperCase()==="FOLGA";

    if(!eventoDia){
      if(temTodasMarcacoes){
        min =
          (hm(dadosAtual.saidaAlmoco) - hm(dadosAtual.entrada)) +
          (hm(dadosAtual.saida) - hm(dadosAtual.retornoAlmoco));
      }
      if(isFeriadoLista) min = 0;
      if(!isFeriadoLista && folgaProgramada && !temAlgumaMarcacao) min = 0;

    } else {
      switch(eventoDia){
        case "Falta Justificada":
          min = -JORNADA_PADRAO;
          totalAtestadosMin += -min;
          break;

        case "Atestado M√©dico Dias":
          min = -JORNADA_PADRAO;
          totalAtestadosMin += -min;
          break;

        case "Atestado M√©dico Horas": {
          const minutosAtestado = Number(dadosAtual.atestadoHorasMin || JORNADA_PADRAO);
          min = -minutosAtestado;
          totalAtestadosMin += minutosAtestado;
          break;
        }

        case "Falta Injustificada":
          min = -JORNADA_PADRAO;
          totalAtrasosFaltasMin += min;
          break;

        case "Falta Abonada":
          min = JORNADA_PADRAO;
          totalAtestadosMin += min;
          break;

        case "F√©rias":
        case "Licen√ßa Maternidade":
        case "Licen√ßa Paternidade":
        case "Licen√ßa INSS+15 D":
        case "Acidente de Trabalho":
          min = JORNADA_PADRAO;
          totalAfastamentosMin += min;
          break;

        case "Feriado":
          min = 0;
          break;
      }
    }

    totalPeriodo += min;

    let creditoMin = min - jornadaEscala;
    if(isFeriadoLista && temAlgumaMarcacao) creditoMin = 16 * 60;

    let nomeDia=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"][weekday];
    if(isFeriadoLista) nomeDia="Feriado";

    let conteudoEntrada, conteudoSaidaAlm, conteudoRetorno, conteudoSaida;

    if(!isFeriadoLista && folgaProgramada && !temAlgumaMarcacao && !eventoDia){
      conteudoEntrada = "FOLGA";
      conteudoSaidaAlm = "FOLGA";
      conteudoRetorno  = "FOLGA";
      conteudoSaida    = "FOLGA";
    } else {
      conteudoEntrada   = campo(dadosAtual.entrada,"entrada");
      conteudoSaidaAlm  = campo(dadosAtual.saidaAlmoco,"saidaAlmoco");
      conteudoRetorno   = campo(dadosAtual.retornoAlmoco,"retornoAlmoco");
      conteudoSaida     = campo(dadosAtual.saida,"saida");
    }

    html+=`<tr>
      <td>${d}</td>
      <td>${nomeDia}</td>
      <td>${conteudoEntrada}</td>
      <td>${conteudoSaidaAlm}</td>
      <td>${conteudoRetorno}</td>
      <td>${conteudoSaida}</td>
      <td class="${min>=0?'verde':'vermelho'}">${fmt(min)}</td>
      <td class="${creditoMin>=0?'verde':'vermelho'}">${creditoMin!==0 ? fmt(creditoMin) : ""}</td>`;

    if(tipo==="comGeo"){
      html+=`<td>${dadosAtual.geoEntrada||""}</td>
             <td>${dadosAtual.geoSaidaAlmoco||""}</td>
             <td>${dadosAtual.geoRetornoAlmoco||""}</td>
             <td>${dadosAtual.geoSaida||""}</td>`;
    }
    html+="</tr>";

    currentDate.setDate(currentDate.getDate()+1);
  }

  html+=`<tr><th colspan="6">TOTAL</th>
           <th class="${totalPeriodo>=0?'verde':'vermelho'}">${fmt(totalPeriodo)}</th>
           <th></th>
         </tr></table>`;

  html+=`<br><h4>Totais do Per√≠odo</h4>`;
  html+=`<p><strong>Total trabalhado:</strong> ${fmt(totalPeriodo)}</p>`;
  html+=`<p><strong>Total de atestados:</strong> ${fmt(totalAtestadosMin)}</p>`;
  html+=`<p><strong>Total de afastamentos:</strong> ${fmt(totalAfastamentosMin)}</p>`;
  html+=`<p><strong>Total atrasos/faltas:</strong> ${fmt(totalAtrasosFaltasMin)}</p>`;
  html+=`<p>Assinatura do Funcion√°rio: _____________________</p>`;

  document.getElementById("cartaoFuncionario").innerHTML=html;
}

/************* EXPORTA√á√ïES *************/
function gerarExcel(){
  const tabelaOriginal = document.querySelector("#tabelaRelatorio");
  if(!tabelaOriginal){ alert("Gere o relat√≥rio do cart√£o de ponto antes de exportar para Excel."); return; }

  const opt = confirm("Deseja gerar o relat√≥rio AJUSTADO?\nOK = Ajustado\nCancelar = Original");
  const tabela = tabelaOriginal.cloneNode(true);

  if(!opt){
    [...tabela.querySelectorAll("td")].forEach(td=>{
      if(td.innerHTML.includes("Editar") || td.innerHTML.includes("‚ûï Ajustar")) td.innerHTML = "";
    });
  } else {
    [...tabela.querySelectorAll("td")].forEach(td=>{
      td.innerHTML = td.innerHTML.replace(/ <button.*<\/button>/g,"");
    });
  }

  const wb = XLSX.utils.book_new();
  const linhas = [];
  const trs = tabela.querySelectorAll("tr");

  function excelSerialFromDMY(dd, mm, yyyy){
    const excelEpoch = Date.UTC(1899, 11, 30);
    const dtUTC = Date.UTC(yyyy, mm - 1, dd);
    return (dtUTC - excelEpoch) / 86400000;
  }

  trs.forEach((tr, rowIndex) => {
    const row = [];
    const cells = tr.querySelectorAll("th,td");

    cells.forEach((cell, colIndex) => {
      let txt = (cell.innerText || cell.textContent || "").trim();
      if(rowIndex > 0 && colIndex === 0){
        const m = txt.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if(m){
          const dd = parseInt(m[1],10);
          const mm = parseInt(m[2],10);
          const yyyy = parseInt(m[3],10);
          row.push(excelSerialFromDMY(dd, mm, yyyy));
        } else row.push(txt);
      } else row.push(txt);
    });

    linhas.push(row);
  });

  const ws = XLSX.utils.aoa_to_sheet(linhas);
  const range = XLSX.utils.decode_range(ws["!ref"]);
  for(let r = 1; r <= range.e.r; r++){
    const addr = XLSX.utils.encode_cell({ c: 0, r: r });
    const cell = ws[addr];
    if(cell && typeof cell.v === "number"){
      cell.t = "n";
      cell.z = "dd/mm/yyyy";
    }
  }

  XLSX.utils.book_append_sheet(wb, ws, "Cart√£o de Ponto");
  XLSX.writeFile(wb, "cartao_ponto.xlsx");
}

async function gerarPDFAdmin(){
  const opt=confirm("Deseja gerar o relat√≥rio AJUSTADO?\nOK = Ajustado\nCancelar = Original");
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF('p','mm','a4');

  doc.setFontSize(12);
  doc.text("RELAT√ìRIO MENSAL DE PONTO",105,10,{align:"center"});

  doc.setFontSize(10);
  const u = funcionarioSelect.value;
  doc.text(`Funcion√°rio: ${users[u]?.nomeCompleto || u}`,14,18);
  doc.text(`PIS: ${users[u]?.pis || ""}`,14,24);
  doc.text(`Per√≠odo: ${dataInicio.value} at√© ${dataFim.value || dataInicio.value}`,14,30);

  const tabela=document.querySelector("#tabelaRelatorio").cloneNode(true);
  if(!opt){
    [...tabela.querySelectorAll("td")].forEach(td=>{
      if(td.innerHTML.includes("Editar") || td.innerHTML.includes("‚ûï Ajustar")) td.innerHTML="";
    });
  } else {
    [...tabela.querySelectorAll("td")].forEach(td=>{
      td.innerHTML=td.innerHTML.replace(/ <button.*<\/button>/g,"");
    });
  }

  doc.autoTable({startY:36,html:tabela});
  doc.text("Assinatura do Funcion√°rio: ______________________",14,doc.lastAutoTable.finalY+10);
  doc.save("cartao_ponto.pdf");
}

/************* CADASTRO FUNCION√ÅRIO (salva no Sheets) *************/
function abrirCadastroFuncionario(){
  modalFuncionario.classList.remove("hidden");
  escSeg.value = "08:00"; escTer.value="08:00"; escQua.value="08:00";
  escQui.value="08:00"; escSex.value="08:00"; escSab.value="04:00"; escDom.value="FOLGA";
}
function fecharCadastroFuncionario(){ modalFuncionario.classList.add("hidden"); }

async function salvarFuncionario(){
  const codigo=novoCodigo.value.trim();
  const nome=novoNome.value.trim();
  const u=novoUser.value.trim();
  const p=novoPass.value.trim();
  const cargo=novoCargo.value.trim();
  const pis=novoPis.value.trim();
  const setor=novoSetor.value.trim();
  const local=novoLocal.value.trim();

  const eSeg = (escSeg.value || "").trim() || "08:00";
  const eTer = (escTer.value || "").trim() || eSeg;
  const eQua = (escQua.value || "").trim() || eSeg;
  const eQui = (escQui.value || "").trim() || eSeg;
  const eSex = (escSex.value || "").trim() || eSeg;
  const eSab = (escSab.value || "").trim() || "04:00";
  const eDom = (escDom.value || "").trim() || "FOLGA";

  if(!u||!p||!pis||!nome){
    alert("Preencha pelo menos: Nome, Usu√°rio, Senha e PIS");
    return;
  }

  // OBS: envia SOMENTE campos que existem no cabe√ßalho da aba FUNCIONARIOS
  const res = await apiPost({
    tipo:"salvarUsuario",
    usuario_login: u,
    senha: p,
    role: "operacional",
    nome: nome,
    pis: pis,
    cargo: cargo,
    setor: setor,
    local_trabalho: local,
    escSeg: eSeg, escTer: eTer, escQua: eQua, escQui: eQui, escSex: eSex, escSab: eSab, escDom: eDom
  });

  if(res.status !== "ok"){
    alert(res.message || "Erro ao salvar usu√°rio na planilha");
    return;
  }

  await carregarUsuarios();
  preencherFuncionarios();
  fecharCadastroFuncionario();

  novoCodigo.value=""; novoNome.value=""; novoUser.value=""; novoPass.value="";
  novoCargo.value=""; novoPis.value=""; novoSetor.value=""; novoLocal.value="";
  escSeg.value="08:00"; escTer.value="08:00"; escQua.value="08:00";
  escQui.value="08:00"; escSex.value="08:00"; escSab.value="04:00"; escDom.value="FOLGA";

  alert("Funcion√°rio salvo com sucesso na planilha!");
}

/************* ESCALA MENSAL (mantida no HTML) *************/
function abrirEscalaMensal(){
  const u=document.getElementById("funcionarioSelect").value;
  if(!u) return alert("Selecione um funcion√°rio");
  const conteudo=document.getElementById("conteudoEscala");
  conteudo.innerHTML="";
  users[u].escalaMensal = users[u].escalaMensal || {};
  for(let i=1;i<=31;i++){
    const val = users[u].escalaMensal[i]||"";
    conteudo.innerHTML+=`Dia ${i}: <input type="text" id="escala${i}" value="${val}" placeholder="HH:MM ou vazio"><br>`;
  }
  modalEscala.classList.remove("hidden");
}
function fecharEscalaMensal(){ modalEscala.classList.add("hidden"); }
function salvarEscalaMensal(){
  const u=document.getElementById("funcionarioSelect").value;
  if(!u) return;
  users[u].escalaMensal = users[u].escalaMensal || {};
  for(let i=1;i<=31;i++){
    users[u].escalaMensal[i]=document.getElementById(`escala${i}`).value.trim();
  }
  fecharEscalaMensal();
  alert("Escala mensal salva no HTML (se quiser, posso criar uma aba no Sheets para salvar tamb√©m).");
}
</script>
</body>
</html>

