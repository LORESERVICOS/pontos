<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Rel√≥gio de Ponto Eletr√¥nico</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.19/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<style>
  body{font-family:Inter;background:#f8fafc;margin:0}
  header{background:#1e40af;color:#fff;padding:20px;font-size:16px}
  .card{background:#fff;padding:25px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.05);margin:20px auto}
  button{padding:6px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff;cursor:pointer;margin:2px}
  button:hover{background:#1d4ed8}
  .btn-danger{background:#dc2626}
  .btn-danger:hover{background:#b91c1c}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:13px}
  th{background:#f1f5f9}
  .verde{color:green;font-weight:bold;}
  .vermelho{color:red;font-weight:bold;}
  input,select{padding:6px 8px;margin:2px 0;border:1px solid #cbd5e1;border-radius:8px}
  .muted{color:#64748b;font-size:12px}
</style>
</head>
<body>
<header>
  Bem-vindo, <span id="nomeUsuario"></span>
</header>

<!-- LOGIN -->
<div id="loginSection" class="card" style="max-width:420px">
  <h2>Login</h2>
  <input id="username" placeholder="Usu√°rio" autocomplete="off" style="width:100%"><br><br>
  <input id="password" type="password" placeholder="Senha" autocomplete="off" style="width:100%"><br><br>
  <button id="btnLogin" onclick="login()">Entrar</button>
  <div id="loginMsg" class="muted" style="margin-top:10px;color:#b91c1c"></div>
  <div class="muted" style="margin-top:8px">
    * O acesso √© validado pela planilha (aba FUNCIONARIOS).<br>
    * Se fechar a aba, precisa logar de novo.
  </div>
</div>

<!-- OPERACIONAL -->
<div id="operacionalSection" class="hidden">
  <div class="card" style="max-width:600px">
    <h2>Registro de Ponto</h2>
    <div id="dataAtual"></div>
    <div id="horaAtual"></div>
    <hr>
    <div id="botoesRegistro"></div>
    <hr>
    <h3>Marca√ß√µes do Dia</h3>
    <div id="registrosUsuario"></div>
    <hr>
    <button onclick="logout()">Sair</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminSection" class="hidden">
  <div class="card" style="max-width:1200px">
    <h2>Relat√≥rio ‚Äì Cart√£o de Ponto</h2>
    <button onclick="abrirCadastroFuncionario()">Cadastro / Edi√ß√£o de Funcion√°rio</button>
    <button onclick="abrirEscalaMensal()">Editar Escala Mensal</button><br><br>

    <select id="funcionarioSelect" onchange="gerarRelatorioMensal()"></select>
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <select id="tipoRelatorio">
      <option value="simples">Relat√≥rio Simples</option>
      <option value="comGeo">Com Geolocaliza√ß√£o</option>
    </select>

    <button onclick="gerarRelatorioMensal()">Gerar</button>
    <button onclick="gerarExcel()">Excel</button>
    <button onclick="gerarPDFAdmin()">PDF</button>
    <button onclick="logout()">Sair</button>

    <div id="cartaoFuncionario"></div>
  </div>
</div>

<!-- MODAL CADASTRO FUNCIONARIO -->
<div id="modalFuncionario" class="card hidden" style="max-width:520px">
  <h3>Cadastro / Edi√ß√£o de Funcion√°rio</h3>
  <div class="muted">Tudo aqui salva/atualiza na planilha (FUNCIONARIOS) e fica din√¢mico no sistema.</div>
  <br>

  <label>C√≥digo Funcion√°rio:<br>
    <input id="novoCodigo" placeholder="C√≥digo" style="width:100%">
  </label><br>

  <label>Nome Funcion√°rio:<br>
    <input id="novoNome" placeholder="Nome completo" style="width:100%">
  </label><br>

  <label>Usu√°rio (login):<br>
    <input id="novoUser" placeholder="Usu√°rio" style="width:100%">
  </label><br>

  <label>Senha:<br>
    <input id="novoPass" type="password" placeholder="Senha" style="width:100%">
  </label><br>

  <label>Cargo:<br>
    <input id="novoCargo" placeholder="Cargo/Fun√ß√£o" style="width:100%">
  </label><br>

  <label>PIS:<br>
    <input id="novoPis" placeholder="PIS" style="width:100%">
  </label><br>

  <label>Depto/Setor:<br>
    <input id="novoSetor" placeholder="Departamento / Setor" style="width:100%">
  </label><br>

  <label>Local de Trabalho:<br>
    <input id="novoLocal" placeholder="Local de trabalho" style="width:100%">
  </label><br>

  <p><strong>Escala padr√£o semanal do funcion√°rio</strong><br>
    Digite <strong>HH:MM</strong> para a carga di√°ria ou <strong>FOLGA</strong>.
  </p>

  <label>Segunda-feira:<br>
    <input id="escSeg" placeholder="HH:MM ou FOLGA" value="08:00" style="width:100%">
  </label><br>

  <label>Ter√ßa-feira:<br>
    <input id="escTer" placeholder="HH:MM ou FOLGA" value="08:00" style="width:100%">
  </label><br>

  <label>Quarta-feira:<br>
    <input id="escQua" placeholder="HH:MM ou FOLGA" value="08:00" style="width:100%">
  </label><br>

  <label>Quinta-feira:<br>
    <input id="escQui" placeholder="HH:MM ou FOLGA" value="08:00" style="width:100%">
  </label><br>

  <label>Sexta-feira:<br>
    <input id="escSex" placeholder="HH:MM ou FOLGA" value="08:00" style="width:100%">
  </label><br>

  <label>S√°bado:<br>
    <input id="escSab" placeholder="HH:MM ou FOLGA" value="04:00" style="width:100%">
  </label><br>

  <label>Domingo:<br>
    <input id="escDom" placeholder="HH:MM ou FOLGA" value="FOLGA" style="width:100%">
  </label><br><br>

  <button onclick="salvarFuncionario()">Salvar</button>
  <button class="btn-danger" onclick="excluirFuncionario()">Excluir</button>
  <button onclick="fecharCadastroFuncionario()">Cancelar</button>
</div>

<!-- MODAL ESCALA MENSAL -->
<div id="modalEscala" class="card hidden" style="max-width:600px;max-height:500px;overflow:auto">
  <h3>Editar Escala Mensal (manual)</h3>
  <p class="muted">Formato HH:MM por dia (opcional ‚Äì usado se quiser sobrescrever a escala semanal)</p>
  <div id="conteudoEscala"></div>
  <button onclick="salvarEscalaMensal()">Salvar Escala</button>
  <button onclick="fecharEscalaMensal()">Cancelar</button>
</div>

<script>
/** =========================================================
 *  ‚úÖ CONFIGURE AQUI A URL DO SEU WEB APP (Apps Script) /exec
 *  ========================================================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPr86F9huzixy6Q0h61BnozR25KMIPgisO4lFv4ZIkfuHaBUR1t8JhtaTemMkMwxlqIg/exec";

/** =========================================================
 *  DADOS / ESTADO (USU√ÅRIOS V√ÉO VIR DA PLANILHA)
 *  ========================================================= */
let users = {};               // cache em mem√≥ria (carregado da planilha sob demanda)
let currentUser = null;       // login atual
let dadosAtual = {}, dataAtualRel = "";
const feriados = ["01/01","07/09","25/12"];

const justificativas = [
  "Nenhum","F√©rias","Falta Justificada","Falta Injustificada","Falta Abonada",
  "Atestado M√©dico Dias","Atestado M√©dico Horas","Licen√ßa Maternidade","Licen√ßa Paternidade",
  "Licen√ßa INSS+15 D","Acidente de Trabalho","Feriado"
];

/** =========================================================
 *  SESS√ÉO (apaga ao fechar aba)
 *  ========================================================= */
function setSessao_(u,p){
  sessionStorage.setItem("auth_ok","1");
  sessionStorage.setItem("auth_user",u);
  sessionStorage.setItem("auth_pass",p);
}
function clearSessao_(){
  sessionStorage.removeItem("auth_ok");
  sessionStorage.removeItem("auth_user");
  sessionStorage.removeItem("auth_pass");
}
function mostrarSomenteLogin_(){
  loginSection.classList.remove("hidden");
  operacionalSection.classList.add("hidden");
  adminSection.classList.add("hidden");
  nomeUsuario.textContent = "";
}

async function restaurarSessaoSePossivel_(){
  const ok = sessionStorage.getItem("auth_ok")==="1";
  const u  = (sessionStorage.getItem("auth_user")||"").trim();
  const p  = (sessionStorage.getItem("auth_pass")||"").trim();
  if(!ok || !u || !p){
    mostrarSomenteLogin_();
    return;
  }
  try{
    const data = await apiPost_({tipo:"login", usuario:u, senha:p});
    if(data.status !== "ok"){
      clearSessao_();
      mostrarSomenteLogin_();
      return;
    }
    aplicarUsuarioLogado_(u,p,data.user);
  }catch(e){
    console.error(e);
    mostrarSomenteLogin_();
  }
}

/** =========================================================
 *  API helper
 *  ========================================================= */
async function apiPost_(payload){
  const resp = await fetch(SCRIPT_URL, {
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify(payload)
  });
  const text = await resp.text();
  let data;
  try { data = JSON.parse(text); }
  catch { throw new Error("Resposta do servidor n√£o √© JSON: " + text.slice(0,180)); }
  return data;
}

/** =========================================================
 *  LOGIN (sempre pela planilha)
 *  ========================================================= */
function aplicarUsuarioLogado_(u,p,info){
  info = info || {};
  users[u] = {
    password: p, // compatibilidade interna
    role: info.role || "operacional",
    pis: info.pis || "",
    codigo: info.codigo || "",
    nomeCompleto: info.nomeCompleto || u,
    cargo: info.cargo || "",
    setor: info.setor || "",
    localTrabalho: info.localTrabalho || "",
    escalaMensal: users[u]?.escalaMensal || {},
    escalaSemanal: info.escalaSemanal || {1:"08:00",2:"08:00",3:"08:00",4:"08:00",5:"08:00",6:"04:00",0:"FOLGA"}
  };

  currentUser = u;
  nomeUsuario.textContent = users[u].nomeCompleto || u;

  setSessao_(u,p);

  loginSection.classList.add("hidden");
  loginMsg.textContent = "";
  username.value = "";
  password.value = "";

  if(users[u].role === "admin"){
    adminSection.classList.remove("hidden");
    operacionalSection.classList.add("hidden");
    carregarFuncionariosDaPlanilha(); // din√¢mico
  }else{
    operacionalSection.classList.remove("hidden");
    adminSection.classList.add("hidden");
    mostrarDataHora();
    mostrarRegistrosUsuario();
  }
}

async function login(){
  loginMsg.textContent = "";
  const u = username.value.trim();
  const p = password.value.trim();
  if(!u || !p){ loginMsg.textContent="Preencha usu√°rio e senha."; return; }

  btnLogin.disabled = true;
  btnLogin.textContent = "Validando...";

  try{
    const data = await apiPost_({tipo:"login", usuario:u, senha:p});
    if(data.status !== "ok"){
      loginMsg.textContent = data.message || "Login inv√°lido.";
      password.value = "";
      return;
    }
    aplicarUsuarioLogado_(u,p,data.user);
  }catch(e){
    console.error(e);
    loginMsg.textContent = "Erro ao conectar com o servidor (veja F12 > Console).";
  }finally{
    btnLogin.disabled = false;
    btnLogin.textContent = "Entrar";
  }
}

function logout(){
  clearSessao_();
  location.reload();
}

document.addEventListener("keydown",(ev)=>{
  if(!loginSection.classList.contains("hidden") && ev.key==="Enter"){
    ev.preventDefault();
    login();
  }
});

restaurarSessaoSePossivel_();

/** =========================================================
 *  ADMIN: carregar lista de funcion√°rios da planilha (din√¢mico)
 *  ========================================================= */
async function carregarFuncionariosDaPlanilha(){
  try{
    const data = await apiPost_({tipo:"listarFuncionarios"});
    if(data.status !== "ok") throw new Error(data.message||"Erro listar");

    const select = document.getElementById("funcionarioSelect");
    select.innerHTML = "<option value=''>Selecionar Funcion√°rio</option>";

    (data.funcionarios||[])
      .filter(f => (f.role||"operacional").toLowerCase() === "operacional") // no cart√£o
      .forEach(f=>{
        const opt = document.createElement("option");
        opt.value = f.login;
        opt.textContent = f.nome || f.login;
        select.appendChild(opt);
      });
  }catch(e){
    console.error(e);
    alert("Erro ao carregar funcion√°rios da planilha.");
  }
}

/** Buscar e cachear 1 funcion√°rio da planilha (para relat√≥rio/escala) */
async function ensureFuncionarioCarregado_(u){
  if(!u) return null;
  if(users[u] && users[u].pis !== undefined && users[u].escalaSemanal) return users[u];

  const data = await apiPost_({tipo:"obterFuncionario", usuario:u});
  if(data.status !== "ok") throw new Error(data.message||"N√£o encontrado");

  const f = data.funcionario;
  users[u] = {
    password: f.senha_ponto || "",
    role: (f.role || "operacional"),
    pis: f.pis || "",
    codigo: f.codigo || "",
    nomeCompleto: f.nome || u,
    cargo: f.cargo || "",
    setor: f.setor || "",
    localTrabalho: f.local_trabalho || "",
    escalaMensal: users[u]?.escalaMensal || {},
    escalaSemanal: {
      1: f.escSeg || "08:00",
      2: f.escTer || "08:00",
      3: f.escQua || "08:00",
      4: f.escQui || "08:00",
      5: f.escSex || "08:00",
      6: f.escSab || "04:00",
      0: f.escDom || "FOLGA"
    }
  };
  return users[u];
}

/** =========================================================
 *  CADASTRO / EDI√á√ÉO: agora pega e salva na planilha (din√¢mico)
 *  ========================================================= */
async function abrirCadastroFuncionario(){
  const u = funcionarioSelect.value; // vazio = novo
  modalFuncionario.classList.remove("hidden");

  // Novo
  if(!u){
    novoCodigo.value=""; novoNome.value=""; novoUser.value=""; novoPass.value="";
    novoCargo.value=""; novoPis.value=""; novoSetor.value=""; novoLocal.value="";
    escSeg.value="08:00"; escTer.value="08:00"; escQua.value="08:00"; escQui.value="08:00";
    escSex.value="08:00"; escSab.value="04:00"; escDom.value="FOLGA";
    return;
  }

  // Editar (busca na planilha)
  try{
    const data = await apiPost_({tipo:"obterFuncionario", usuario:u});
    if(data.status !== "ok"){ alert(data.message||"Erro ao obter"); return; }
    const f = data.funcionario;

    novoCodigo.value = f.codigo || "";
    novoNome.value   = f.nome || "";
    novoUser.value   = f.usuario_login || u;
    novoPass.value   = f.senha_ponto || "";
    novoCargo.value  = f.cargo || "";
    novoPis.value    = f.pis || "";
    novoSetor.value  = f.setor || "";
    novoLocal.value  = f.local_trabalho || "";

    escSeg.value = f.escSeg || "08:00";
    escTer.value = f.escTer || "08:00";
    escQua.value = f.escQua || "08:00";
    escQui.value = f.escQui || "08:00";
    escSex.value = f.escSex || "08:00";
    escSab.value = f.escSab || "04:00";
    escDom.value = f.escDom || "FOLGA";
  }catch(e){
    console.error(e);
    alert("Erro ao carregar funcion√°rio.");
  }
}

function fecharCadastroFuncionario(){ modalFuncionario.classList.add("hidden"); }

async function salvarFuncionario(){
  const codigo=novoCodigo.value.trim();
  const nome=novoNome.value.trim();
  const u=novoUser.value.trim();
  const p=novoPass.value.trim();
  const cargo=novoCargo.value.trim();
  const pis=novoPis.value.trim();
  const setor=novoSetor.value.trim();
  const local=novoLocal.value.trim();

  const eSeg = (escSeg.value || "").trim() || "08:00";
  const eTer = (escTer.value || "").trim() || eSeg;
  const eQua = (escQua.value || "").trim() || eSeg;
  const eQui = (escQui.value || "").trim() || eSeg;
  const eSex = (escSex.value || "").trim() || eSeg;
  const eSab = (escSab.value || "").trim() || "04:00";
  const eDom = (escDom.value || "").trim() || "FOLGA";

  if(!u||!p||!pis||!nome){
    alert("Preencha pelo menos: Nome, Usu√°rio, Senha e PIS");
    return;
  }

  try{
    const data = await apiPost_({
      tipo:"salvarFuncionario",
      usuario: u,
      senha: p,
      codigo: codigo,
      nome: nome,
      pis: pis,
      cargo: cargo,
      setor: setor,
      local_trabalho: local,
      escSeg: eSeg, escTer: eTer, escQua: eQua, escQui: eQui, escSex: eSex, escSab: eSab, escDom: eDom,
      role: "operacional"
    });

    if(data.status !== "ok"){
      alert(data.message || "Erro ao salvar na planilha.");
      return;
    }

    // Atualiza cache local (para relat√≥rio imediato)
    users[u] = {
      password:p, role:"operacional",
      pis, codigo, nomeCompleto:nome, cargo, setor, localTrabalho:local,
      escalaMensal: users[u]?.escalaMensal || {},
      escalaSemanal:{1:eSeg,2:eTer,3:eQua,4:eQui,5:eSex,6:eSab,0:eDom}
    };

    alert("Funcion√°rio salvo com sucesso na planilha!");
    await carregarFuncionariosDaPlanilha();
    fecharCadastroFuncionario();
  }catch(e){
    console.error(e);
    alert("Erro ao salvar na planilha. Veja o console (F12).");
  }
}

async function excluirFuncionario(){
  const u = novoUser.value.trim();
  if(!u) return alert("Informe o usu√°rio para excluir.");
  if(!confirm("Excluir o usu√°rio '"+u+"' da planilha?")) return;

  try{
    const data = await apiPost_({tipo:"excluirFuncionario", usuario:u});
    if(data.status !== "ok"){
      alert(data.message || "Erro ao excluir.");
      return;
    }
    delete users[u];
    alert("Exclu√≠do com sucesso!");
    await carregarFuncionariosDaPlanilha();
    fecharCadastroFuncionario();
  }catch(e){
    console.error(e);
    alert("Erro ao excluir na planilha. Veja o console (F12).");
  }
}

/** =========================================================
 *  OPERACIONAL
 *  ========================================================= */
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

function registrar(tipo){
  const agora=new Date();
  const hora=agora.toLocaleTimeString().slice(0,5);
  const data=agora.toLocaleDateString();
  navigator.geolocation.getCurrentPosition(
    pos=> salvarRegistro(tipo,hora,data,`${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`),
    ()=> salvarRegistro(tipo,hora,data,"N√£o registrada")
  );
}
function salvarRegistro(tipo,hora,data,geo){
  const d=JSON.parse(localStorage.getItem("registros")||"{}");
  d[currentUser]??={};
  d[currentUser][data]??={};
  d[currentUser][data][tipo]=hora;
  d[currentUser][data]["geo"+capitalize(tipo)]=geo;
  localStorage.setItem("registros",JSON.stringify(d));
  mostrarRegistrosUsuario();
}
function mostrarDataHora(){
  setInterval(()=>{
    const a=new Date();
    dataAtual.textContent="Data: "+a.toLocaleDateString();
    horaAtual.textContent="Hora: "+a.toLocaleTimeString();
  },1000);
}
function mostrarRegistrosUsuario(){
  const hoje=new Date().toLocaleDateString();
  const d=JSON.parse(localStorage.getItem("registros")||"{}");
  const r=d[currentUser]?.[hoje]||{};
  registrosUsuario.innerHTML="";
  botoesRegistro.innerHTML="";

  ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(t=>{
    if(r[t]){
      registrosUsuario.innerHTML+=`<div><strong>${capitalize(t)}:</strong> ${r[t]} <button style="font-size:11px" onclick="gerarComprovante('${t}')">üìÑ PDF</button></div>`;
    }
  });

  if(!r.entrada) botoesRegistro.innerHTML=`<button onclick="registrar('entrada')">Entrada</button>`;
  else if(!r.saidaAlmoco) botoesRegistro.innerHTML=`<button onclick="registrar('saidaAlmoco')">Sa√≠da Almo√ßo</button>`;
  else if(!r.retornoAlmoco) botoesRegistro.innerHTML=`<button onclick="registrar('retornoAlmoco')">Retorno</button>`;
  else if(!r.saida) botoesRegistro.innerHTML=`<button onclick="registrar('saida')">Sa√≠da</button>`;
  else botoesRegistro.innerHTML="‚úÖ Jornada finalizada";
}

/** ====== COMPROVANTE INDIVIDUAL ====== */
function gerarComprovante(tipo){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  const hoje=new Date().toLocaleDateString();
  const d=JSON.parse(localStorage.getItem("registros")||"{}");
  const r=d[currentUser]?.[hoje]||{};
  const hora=r[tipo]||"";
  const geo=r["geo"+capitalize(tipo)]||"";

  doc.setFontSize(14);
  doc.text("COMPROVANTE DE REGISTRO DE PONTO",105,15,{align:"center"});
  doc.setFontSize(11);
  doc.text(`Colaborador: ${users[currentUser]?.nomeCompleto || currentUser}`,14,30);
  doc.text(`PIS: ${users[currentUser]?.pis||""}`,14,36);
  doc.text(`Data: ${hoje}`,14,42);
  doc.text(`Tipo de Marca√ß√£o: ${capitalize(tipo)}`,14,48);
  doc.text(`Hor√°rio: ${hora}`,14,54);
  doc.text(`Geolocaliza√ß√£o: ${geo}`,14,60);
  doc.save(`comprovante_${tipo}_${hoje}.pdf`);
}

/** =========================================================
 *  RELAT√ìRIO / C√ÅLCULOS
 *  ========================================================= */
function hm(h){
  if(!h || typeof h!=="string" || !h.includes(":")) return 0;
  const[x,y]=h.split(":").map(Number);
  return x*60+y;
}
function fmt(m){
  const sign = m<0 ? "-" : "";
  const abs = Math.abs(m);
  const h = String(Math.floor(abs/60)).padStart(2,"0");
  const mm = String(abs%60).padStart(2,"0");
  return sign + h + ":" + mm;
}
function cargaEscalaMin(escStr){
  if(!escStr) return 0;
  const s = escStr.toString().toUpperCase().trim();
  if(s==="FOLGA") return 0;
  if(/^\d{2}:\d{2}$/.test(s)) return hm(s);
  if(s.includes("=")){
    const partes = s.split("=");
    const carga = partes[partes.length-1].trim();
    if(/^\d{2}:\d{2}$/.test(carga)) return hm(carga);
  }
  return 0;
}

/** ====== AJUSTE ====== */
function campo(valor, c, adminView = true){
  const vazio = !valor || valor === "-";
  const evento = dadosAtual[c+"_evento"];

  if(!vazio && !evento){
    if(adminView){
      return valor + (dadosAtual[c+"_editado"]
        ? ` <button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${dataAtualRel}','${c}')">Editar</button>`
        : "");
    }
    return valor;
  }

  if(evento){
    if(adminView){
      return evento +
        ` <button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${dataAtualRel}','${c}')">Editar</button>`;
    }
    return evento;
  }

  if(adminView){
    return `<button style="font-size:11px" onclick="abrirAjuste('${funcionarioSelect.value}','${dataAtualRel}','${c}')">‚ûï Ajustar</button>`;
  }
  return "";
}

function abrirAjuste(u,d,c){
  const dados = JSON.parse(localStorage.getItem("registros")||"{}");
  dados[u]??={};
  dados[u][d]??={};
  const atual = dados[u][d];

  let popup = document.createElement("div");
  popup.style.position="fixed";
  popup.style.top="50%";
  popup.style.left="50%";
  popup.style.transform="translate(-50%,-50%)";
  popup.style.background="#fff";
  popup.style.padding="20px";
  popup.style.border="1px solid #333";
  popup.style.borderRadius="12px";
  popup.style.zIndex=1000;

  popup.innerHTML=`
    <h3 style="margin-top:0">Ajustar ${c}</h3>
    <label>Horas: <input type="text" id="inputHoras" placeholder="HH:MM" value="${atual[c]||""}"></label><br><br>
    <label>Justificar:
      <select id="selectJustificacao">
        <option value="">--Escolha--</option>
        ${justificativas.map(j=>`<option value="${j}" ${atual[c+"_evento"]===j?'selected':''}>${j}</option>`).join("")}
      </select>
    </label><br><br>
    <button id="okBtn">Ok</button>
    <button id="cancelBtn" class="btn-danger">Cancelar</button>
  `;

  document.body.appendChild(popup);

  popup.querySelector("#okBtn").onclick=()=>{
    const h = popup.querySelector("#inputHoras").value.trim();
    const ev = popup.querySelector("#selectJustificacao").value;

    if(ev === "Nenhum"){
      ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
        delete atual[campoNome+"_evento"];
        delete atual[campoNome+"_editado"];
        if(atual[campoNome] === "-" || atual[campoNome] === "" || atual[campoNome] == null){
          delete atual[campoNome];
        }
      });
      delete atual.atestadoHorasMin;
      localStorage.setItem("registros",JSON.stringify(dados));
      popup.remove();
      gerarRelatorioMensal();
      return;
    }

    if(ev === "Atestado M√©dico Dias"){
      const intervalo = prompt("Informe o intervalo do atestado (dd/mm/aaaa - dd/mm/aaaa):", d+" - "+d);
      if(intervalo){
        const partes = intervalo.split("-");
        if(partes.length===2){
          const iniStr = partes[0].trim();
          const fimStr = partes[1].trim();
          const [di,mi,ai] = iniStr.split("/").map(Number);
          const [df,mf,af] = fimStr.split("/").map(Number);
          if(di&&mi&&ai&&df&&mf&&af){
            let dataIni = new Date(ai,mi-1,di);
            let dataFim = new Date(af,mf-1,df);
            if(dataIni > dataFim){ const tmp = dataIni; dataIni = dataFim; dataFim = tmp; }
            let cursor = new Date(dataIni);
            while(cursor <= dataFim){
              const cdia = String(cursor.getDate()).padStart(2,"0");
              const cmes = String(cursor.getMonth()+1).padStart(2,"0");
              const cano = cursor.getFullYear();
              const chave = `${cdia}/${cmes}/${cano}`;
              dados[u]??={};
              dados[u][chave]??={};
              const reg = dados[u][chave];
              ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
                reg[campoNome]="-";
                reg[campoNome+"_evento"]=ev;
                reg[campoNome+"_editado"]=true;
              });
              delete reg.atestadoHorasMin;
              cursor.setDate(cursor.getDate()+1);
            }
            localStorage.setItem("registros",JSON.stringify(dados));
            popup.remove();
            gerarRelatorioMensal();
            return;
          }
        }
      }
    }

    if(ev === "Atestado M√©dico Horas"){
      const dataAtestadoStr = prompt("Data do atestado (dd/mm/aaaa):", d);
      if(!dataAtestadoStr){ popup.remove(); return; }
      const [ddia,dmes,dano] = dataAtestadoStr.split("/").map(Number);
      if(!ddia||!dmes||!dano){ popup.remove(); return; }
      const dataAtestadoKey = `${String(ddia).padStart(2,"0")}/${String(dmes).padStart(2,"0")}/${dano}`;
      const hIni = prompt("Hora IN√çCIO do atestado (HH:MM):","08:00");
      const hFim = prompt("Hora FIM do atestado (HH:MM):","10:00");
      if(!hIni || !hFim){ popup.remove(); return; }
      const minutosAtestado = Math.max(0, hm(hFim) - hm(hIni));
      dados[u]??={};
      dados[u][dataAtestadoKey]??={};
      const regA = dados[u][dataAtestadoKey];
      ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
        regA[campoNome]="-";
        regA[campoNome+"_evento"]=ev;
        regA[campoNome+"_editado"]=true;
      });
      regA.atestadoHorasMin = minutosAtestado;
      localStorage.setItem("registros",JSON.stringify(dados));
      popup.remove();
      gerarRelatorioMensal();
      return;
    }

    if(h){
      atual[c]=h;
      atual[c+"_evento"]="";
      atual[c+"_editado"]=true;
      delete atual.atestadoHorasMin;
    } else if(ev){
      ["entrada","saidaAlmoco","retornoAlmoco","saida"].forEach(campoNome=>{
        atual[campoNome]="-";
        atual[campoNome+"_evento"]=ev;
        atual[campoNome+"_editado"]=true;
      });
      delete atual.atestadoHorasMin;
    }

    localStorage.setItem("registros",JSON.stringify(dados));
    popup.remove();
    gerarRelatorioMensal();
  };

  popup.querySelector("#cancelBtn").onclick=()=>{popup.remove();};
}

/** ====== RELAT√ìRIO CART√ÉO DE PONTO ====== */
async function gerarRelatorioMensal(){
  const u=document.getElementById("funcionarioSelect").value;
  if(!u || !dataInicio.value) return;

  try{
    // garante dados do funcion√°rio vindo da planilha
    await ensureFuncionarioCarregado_(u);
  }catch(e){
    console.error(e);
    alert("N√£o consegui carregar dados do funcion√°rio na planilha.");
    return;
  }

  const tipo=document.getElementById("tipoRelatorio").value;
  const registros=JSON.parse(localStorage.getItem("registros")||"{}")[u]||{};
  const escSem = users[u].escalaSemanal || {};

  let totalPeriodo=0;
  let totalAtestadosMin = 0;
  let totalAfastamentosMin = 0;
  let totalAtrasosFaltasMin = 0;

  let html=`<h3>Cart√£o de Ponto - ${users[u].nomeCompleto || u}</h3>`;
  html+=`<p>C√≥digo: ${users[u].codigo || ""} | PIS: ${users[u].pis || ""} | Cargo: ${users[u].cargo || ""} | Setor: ${users[u].setor || ""} | Local: ${users[u].localTrabalho || ""}</p>`;
  html+=`<p>Per√≠odo: ${dataInicio.value} at√© ${dataFim.value || dataInicio.value}</p>`;
  html+=`<table id="tabelaRelatorio"><tr>
    <th>Data</th><th>Dia</th><th>Entrada</th><th>Sa√≠da Almo√ßo</th><th>Retorno</th><th>Sa√≠da</th><th>Total</th><th>Cr√©dito</th>`;
  if(tipo==="comGeo") html+=`<th>Geo Entrada</th><th>Geo Sa√≠da Almo√ßo</th><th>Geo Retorno</th><th>Geo Sa√≠da</th>`;
  html+="</tr>";

  const inicio = new Date(dataInicio.value);
  const fim = dataFim.value ? new Date(dataFim.value) : inicio;
  let currentDate = new Date(inicio);

  while(currentDate <= fim){
    const dia = String(currentDate.getDate()).padStart(2,"0");
    const mes = String(currentDate.getMonth()+1).padStart(2,"0");
    const ano = currentDate.getFullYear();
    const d = `${dia}/${mes}/${ano}`;
    const ddmm = `${dia}/${mes}`;

    dadosAtual = registros[d] || {};
    dataAtualRel = d;

    const JORNADA_PADRAO = 480; // 8h

    const weekday = currentDate.getDay(); // 0=Dom ... 6=S√°b
    const escStr = escSem[weekday] || "";
    const jornadaEscala = cargaEscalaMin(escStr);
    const isFeriadoLista = feriados.includes(ddmm);

    let min = 0;

    const eventos = [
      dadosAtual.entrada_evento,
      dadosAtual.saidaAlmoco_evento,
      dadosAtual.retornoAlmoco_evento,
      dadosAtual.saida_evento
    ].filter(Boolean);
    const eventoDia = eventos[0] || "";

    const temTodasMarcacoes =
      dadosAtual.entrada &&
      dadosAtual.saidaAlmoco &&
      dadosAtual.retornoAlmoco &&
      dadosAtual.saida;

    const temAlgumaMarcacao =
      dadosAtual.entrada || dadosAtual.saidaAlmoco || dadosAtual.retornoAlmoco || dadosAtual.saida;

    const folgaProgramada = escStr && escStr.toString().trim().toUpperCase()==="FOLGA";

    if(!eventoDia){
      if(temTodasMarcacoes){
        min =
          (hm(dadosAtual.saidaAlmoco) - hm(dadosAtual.entrada)) +
          (hm(dadosAtual.saida) - hm(dadosAtual.retornoAlmoco));
      }
      if(isFeriadoLista){
        min = 0;
      }
      if(!isFeriadoLista && folgaProgramada && !temAlgumaMarcacao){
        min = 0;
      }
    } else {
      switch(eventoDia){
        case "Falta Justificada":
          min = -JORNADA_PADRAO;
          totalAtestadosMin += -min;
          break;
        case "Atestado M√©dico Dias":
          min = -JORNADA_PADRAO;
          totalAtestadosMin += -min;
          break;
        case "Atestado M√©dico Horas": {
          const minutosAtestado = dadosAtual.atestadoHorasMin || JORNADA_PADRAO;
          min = -minutosAtestado;
          totalAtestadosMin += minutosAtestado;
          break;
        }
        case "Falta Injustificada":
          min = -JORNADA_PADRAO;
          totalAtrasosFaltasMin += min;
          break;
        case "Falta Abonada":
          min = JORNADA_PADRAO;
          totalAtestadosMin += min;
          break;
        case "F√©rias":
        case "Licen√ßa Maternidade":
        case "Licen√ßa Paternidade":
        case "Licen√ßa INSS+15 D":
        case "Acidente de Trabalho":
          min = JORNADA_PADRAO;
          totalAfastamentosMin += min;
          break;
        case "Feriado":
          min = 0;
          break;
      }
    }

    totalPeriodo += min;

    let creditoMin = min - jornadaEscala;
    if(isFeriadoLista && temAlgumaMarcacao){
      creditoMin = 16 * 60;
    }

    let nomeDia=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"][weekday];
    if(isFeriadoLista) nomeDia="Feriado";

    let conteudoEntrada, conteudoSaidaAlm, conteudoRetorno, conteudoSaida;

    if(!isFeriadoLista && folgaProgramada && !temAlgumaMarcacao && !eventoDia){
      conteudoEntrada = "FOLGA";
      conteudoSaidaAlm = "FOLGA";
      conteudoRetorno  = "FOLGA";
      conteudoSaida    = "FOLGA";
    } else {
      conteudoEntrada   = campo(dadosAtual.entrada,"entrada");
      conteudoSaidaAlm  = campo(dadosAtual.saidaAlmoco,"saidaAlmoco");
      conteudoRetorno   = campo(dadosAtual.retornoAlmoco,"retornoAlmoco");
      conteudoSaida     = campo(dadosAtual.saida,"saida");
    }

    html+=`<tr>
      <td>${d}</td>
      <td>${nomeDia}</td>
      <td>${conteudoEntrada}</td>
      <td>${conteudoSaidaAlm}</td>
      <td>${conteudoRetorno}</td>
      <td>${conteudoSaida}</td>
      <td class="${min>=0?'verde':'vermelho'}">${fmt(min)}</td>
      <td class="${creditoMin>=0?'verde':'vermelho'}">${creditoMin!==0 ? fmt(creditoMin) : ""}</td>`;
    if(tipo==="comGeo"){
      html+=`<td>${dadosAtual.geoEntrada||""}</td>
             <td>${dadosAtual.geoSaidaAlmoco||""}</td>
             <td>${dadosAtual.geoRetorno||""}</td>
             <td>${dadosAtual.geoSaida||""}</td>`;
    }
    html+="</tr>";

    currentDate.setDate(currentDate.getDate()+1);
  }

  html+=`<tr><th colspan="6">TOTAL</th>
           <th class="${totalPeriodo>=0?'verde':'vermelho'}">${fmt(totalPeriodo)}</th>
           <th></th>
         </tr></table>`;

  html+=`<br><h4>Totais do Per√≠odo</h4>`;
  html+=`<p><strong>Total trabalhado (registros + justificativas):</strong> ${fmt(totalPeriodo)}</p>`;
  html+=`<p><strong>Total de atestados</strong> (Atestado dias/horas, Falta Justificada, Falta Abonada, Licen√ßa INSS+15 D): ${fmt(totalAtestadosMin)}</p>`;
  html+=`<p><strong>Total de afastamentos</strong> (F√©rias, Licen√ßa Maternidade, Licen√ßa Paternidade, Acidente de Trabalho): ${fmt(totalAfastamentosMin)}</p>`;
  html+=`<p><strong>Total atrasos/faltas</strong> (Falta Injustificada): ${fmt(totalAtrasosFaltasMin)}</p>`;
  html+=`<p>Assinatura do Funcion√°rio: _____________________</p>`;

  document.getElementById("cartaoFuncionario").innerHTML=html;
}

/** ====== EXCEL ====== */
function gerarExcel(){
  const tabelaOriginal = document.querySelector("#tabelaRelatorio");
  if(!tabelaOriginal){
    alert("Gere o relat√≥rio do cart√£o de ponto antes de exportar para Excel.");
    return;
  }

  const opt = confirm("Deseja gerar o relat√≥rio AJUSTADO?\nOK = Ajustado\nCancelar = Original");
  const tabela = tabelaOriginal.cloneNode(true);

  if(!opt){
    [...tabela.querySelectorAll("td")].forEach(td=>{
      if(td.innerHTML.includes("Editar") || td.innerHTML.includes("‚ûï Ajustar")){
        td.innerHTML = "";
      }
    });
  } else {
    [...tabela.querySelectorAll("td")].forEach(td=>{
      td.innerHTML = td.innerHTML.replace(/ <button.*<\/button>/g,"");
    });
  }

  const wb = XLSX.utils.book_new();
  const linhas = [];
  const trs = tabela.querySelectorAll("tr");

  function excelSerialFromDMY(dd, mm, yyyy){
    const excelEpoch = Date.UTC(1899, 11, 30);
    const dtUTC = Date.UTC(yyyy, mm - 1, dd);
    return (dtUTC - excelEpoch) / 86400000;
  }

  trs.forEach((tr, rowIndex) => {
    const row = [];
    const cells = tr.querySelectorAll("th,td");

    cells.forEach((cell, colIndex) => {
      let txt = (cell.innerText || cell.textContent || "").trim();

      if(rowIndex > 0 && colIndex === 0){
        const m = txt.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if(m){
          const dd = parseInt(m[1],10);
          const mm = parseInt(m[2],10);
          const yyyy = parseInt(m[3],10);
          row.push(excelSerialFromDMY(dd, mm, yyyy));
        } else row.push(txt);
      } else row.push(txt);
    });

    linhas.push(row);
  });

  const ws = XLSX.utils.aoa_to_sheet(linhas);

  const range = XLSX.utils.decode_range(ws["!ref"]);
  for(let r = 1; r <= range.e.r; r++){
    const addr = XLSX.utils.encode_cell({ c: 0, r: r });
    const cell = ws[addr];
    if(cell && typeof cell.v === "number"){
      cell.t = "n";
      cell.z = "dd/mm/yyyy";
    }
  }

  XLSX.utils.book_append_sheet(wb, ws, "Cart√£o de Ponto");
  XLSX.writeFile(wb, "cartao_ponto.xlsx");
}

/** ====== PDF ADMIN ====== */
function gerarPDFAdmin(){
  const opt=confirm("Deseja gerar o relat√≥rio AJUSTADO?\nOK = Ajustado\nCancelar = Original");
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF('p','mm','a4');

  const func = funcionarioSelect.value;
  const dados = JSON.parse(localStorage.getItem("registros")||"{}")[func] || {};

  let qtdFaltasInjustificadas = 0;
  if(dataInicio.value){
    const inicio = new Date(dataInicio.value);
    const fim = dataFim.value ? new Date(dataFim.value) : inicio;
    let currentDate = new Date(inicio);

    while(currentDate <= fim){
      const dia = String(currentDate.getDate()).padStart(2,"0");
      const mes = String(currentDate.getMonth()+1).padStart(2,"0");
      const ano = currentDate.getFullYear();
      const d = `${dia}/${mes}/${ano}`;

      const regDia = dados[d] || {};
      const eventosDia = [
        regDia.entrada_evento,
        regDia.saidaAlmoco_evento,
        regDia.retornoAlmoco_evento,
        regDia.saida_evento
      ].filter(Boolean);

      if(eventosDia.includes("Falta Injustificada")) qtdFaltasInjustificadas++;
      currentDate.setDate(currentDate.getDate()+1);
    }
  }

  doc.setFontSize(12);
  doc.text("RELAT√ìRIO MENSAL DE PONTO",105,10,{align:"center"});
  doc.setFontSize(9);
  doc.text(`Faltas Injustificadas (desconto f√©rias): ${qtdFaltasInjustificadas} dia(s)`, 200, 10, {align:"right"});

  doc.setFontSize(10);
  const u = func;
  doc.text(`Funcion√°rio: ${users[u]?.nomeCompleto || u}`,14,18);
  doc.text(`C√≥digo: ${users[u]?.codigo || ""}`,14,24);
  doc.text(`PIS: ${users[u]?.pis || ""}`,14,30);
  doc.text(`Per√≠odo: ${dataInicio.value} at√© ${dataFim.value || dataInicio.value}`,14,36);

  const tabela=document.querySelector("#tabelaRelatorio")?.cloneNode(true);
  if(!tabela){ alert("Gere o relat√≥rio antes do PDF."); return; }

  if(!opt){
    [...tabela.querySelectorAll("td")].forEach(td=>{
      if(td.innerHTML.includes("Editar") || td.innerHTML.includes("‚ûï Ajustar")) td.innerHTML="";
    });
  } else {
    [...tabela.querySelectorAll("td")].forEach(td=>{
      td.innerHTML=td.innerHTML.replace(/ <button.*<\/button>/g,"");
    });
  }

  doc.autoTable({startY:42,html:tabela});
  doc.text("Assinatura do Funcion√°rio: ______________________",14,doc.lastAutoTable.finalY+10);
  doc.save("cartao_ponto.pdf");
}

/** ====== ESCALA MENSAL (manual local) ====== */
async function abrirEscalaMensal(){
  const u=document.getElementById("funcionarioSelect").value;
  if(!u) return alert("Selecione um funcion√°rio");

  try{
    await ensureFuncionarioCarregado_(u);
  }catch(e){
    console.error(e);
    return alert("N√£o consegui carregar funcion√°rio da planilha.");
  }

  const conteudo=document.getElementById("conteudoEscala");
  conteudo.innerHTML="";
  for(let i=1;i<=31;i++){
    const val = users[u].escalaMensal[i]||"";
    conteudo.innerHTML+=`Dia ${i}: <input type="text" id="escala${i}" value="${val}" placeholder="HH:MM ou vazio"><br>`;
  }
  modalEscala.classList.remove("hidden");
}
function fecharEscalaMensal(){ modalEscala.classList.add("hidden"); }
function salvarEscalaMensal(){
  const u=document.getElementById("funcionarioSelect").value;
  if(!u) return;
  for(let i=1;i<=31;i++){
    users[u].escalaMensal[i]=document.getElementById(`escala${i}`).value.trim();
  }
  fecharEscalaMensal();
  alert("Escala mensal manual salva (local).");
}
</script>
</body>
</html>
